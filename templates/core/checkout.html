{% extends 'base.html' %}

{% block title %}Checkout - {{ plan.name }}{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="row g-4">
                    <!-- Order Summary -->
                    <div class="col-md-7 order-2 order-md-1">
                        <div class="card p-4">
                            <h4 class="fw-bold mb-4">Order Summary</h4>

                            <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                                <span class="text-muted">Selected Plan</span>
                                <span class="badge bg-primary fs-6">{{ plan.name }}</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                                <span class="text-muted">Billing Period</span>
                                <span class="fw-medium">{% if is_yearly %}Yearly{% else %}Monthly{% endif %}</span>
                            </div>

                            {% if plan.description %}
                            <div class="mb-3 pb-3 border-bottom">
                                <span class="text-muted d-block mb-2">Description</span>
                                <p class="mb-0">{{ plan.description }}</p>
                            </div>
                            {% endif %}

                            {% if plan.features %}
                            <div class="mb-4">
                                <span class="text-muted d-block mb-3">Features Included</span>
                                <ul class="list-unstyled mb-0">
                                    {% for feature in plan.features %}
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                                        {{ feature.description }}
                                        {% if feature.limit %}
                                        <span class="badge bg-light text-dark ms-1">{{ feature.limit }}</span>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}

                        </div>

                        <div class="mt-4">
                            <a href="{% url 'pricing' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i> Back to Plans
                            </a>
                        </div>
                    </div>

                    <!-- Payment Section -->
                    <div class="col-md-5 order-1 order-md-2">
                        <div class="card p-4">
                            <h5 class="fw-bold mb-4">Payment</h5>

                            <!-- Coupon Code Section -->
                            <div class="mb-4 pb-3 border-bottom">
                                <label class="text-muted d-block mb-2">Have a coupon code?</label>
                                <div class="input-group">
                                    <input type="text" id="coupon-input" class="form-control" placeholder="Enter coupon code"
                                           value="{% if applied_coupon %}{{ applied_coupon.code }}{% endif %}"
                                           {% if applied_coupon %}disabled{% endif %}>
                                    <button class="btn btn-outline-primary" type="button" id="apply-coupon-btn"
                                            {% if applied_coupon %}style="display:none;"{% endif %}>
                                        Apply
                                    </button>
                                    <button class="btn btn-outline-danger" type="button" id="remove-coupon-btn"
                                            {% if not applied_coupon %}style="display:none;"{% endif %}>
                                        Remove
                                    </button>
                                </div>
                                <div id="coupon-message" class="mt-2 small">
                                    {% if applied_coupon %}
                                    <span class="text-success"><i class="bi bi-check-circle me-1"></i>{{ applied_coupon.discount_percentage }}% discount applied!</span>
                                    {% endif %}
                                </div>
                                {% if public_coupons %}
                                <div class="mt-2 d-flex flex-wrap gap-2">
                                    {% for pc in public_coupons %}
                                    <button type="button" class="btn btn-sm btn-outline-success public-coupon-chip"
                                            data-code="{{ pc.code }}"
                                            {% if applied_coupon and applied_coupon.code == pc.code %}disabled{% endif %}>
                                        <i class="bi bi-tag-fill me-1"></i>{{ pc.code }} — {{ pc.discount_percentage }}% OFF
                                    </button>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Price Summary -->
                            {% if applied_coupon %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Original Price</span>
                                <span class="text-muted text-decoration-line-through">{{ currency_symbol }}{{ original_price }}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-success">Discount ({{ applied_coupon.discount_percentage }}%)</span>
                                <span class="text-success">-{{ currency_symbol }}{{ discount_amount }}</span>
                            </div>
                            {% endif %}

                            <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
                                <span class="fs-5 fw-bold">Total Amount</span>
                                <span class="fs-4 fw-bold text-primary" id="total-price">{{ currency_symbol }}{{ price }}</span>
                            </div>

                            <button id="rzp-button" class="btn btn-primary btn-lg w-100 mb-3">
                                <span class="btn-text">
                                    <i class="bi bi-lock-fill me-2"></i> Pay {{ currency_symbol }}{{ price }}
                                </span>
                                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            </button>

                            <div class="text-center mb-4">
                                <small class="text-muted">
                                    <i class="bi bi-shield-check me-1"></i>
                                    Secured by Razorpay | 256-bit encryption
                                </small>
                            </div>

                            <hr>

                            <div class="text-center">
                                <p class="small text-muted mb-2">Accepted Payment Methods</p>
                                <div class="d-flex justify-content-center gap-3 flex-wrap">
                                    <span class="badge bg-light text-dark p-2">Credit/Debit Cards</span>
                                    <span class="badge bg-light text-dark p-2">UPI</span>
                                    <span class="badge bg-light text-dark p-2">Net Banking</span>
                                    <span class="badge bg-light text-dark p-2">Wallets</span>
                                </div>
                            </div>
                        </div>

                        <div class="card p-3 mt-3 bg-light">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-info-circle text-primary me-2 mt-1"></i>
                                <small class="text-muted">
                                    Your subscription will start immediately after successful payment.
                                    You can cancel anytime from your account settings.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const rzpButton = document.getElementById('rzp-button');
    const btnText = rzpButton.querySelector('.btn-text');
    const spinner = rzpButton.querySelector('.spinner-border');

    // Coupon elements
    const couponInput = document.getElementById('coupon-input');
    const applyCouponBtn = document.getElementById('apply-coupon-btn');
    const removeCouponBtn = document.getElementById('remove-coupon-btn');
    const couponMessage = document.getElementById('coupon-message');

    // Current coupon code (if applied)
    let appliedCouponCode = '{% if applied_coupon %}{{ applied_coupon.code }}{% endif %}';

    // Apply coupon button click
    applyCouponBtn.addEventListener('click', function() {
        const code = couponInput.value.trim();
        if (!code) {
            couponMessage.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle me-1"></i>Please enter a coupon code</span>';
            return;
        }

        applyCouponBtn.disabled = true;
        applyCouponBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        // Validate coupon via AJAX
        fetch('{% url "validate_coupon" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'code=' + encodeURIComponent(code)
        })
        .then(response => response.json())
        .then(data => {
            applyCouponBtn.disabled = false;
            applyCouponBtn.innerHTML = 'Apply';

            if (data.valid) {
                // Reload page with coupon parameter to recalculate price
                const url = new URL(window.location.href);
                url.searchParams.set('coupon', code);
                window.location.href = url.toString();
            } else {
                couponMessage.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle me-1"></i>' + data.error + '</span>';
            }
        })
        .catch(error => {
            applyCouponBtn.disabled = false;
            applyCouponBtn.innerHTML = 'Apply';
            couponMessage.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle me-1"></i>Error validating coupon</span>';
        });
    });

    // Remove coupon button click — set empty coupon param so auto-apply doesn't re-trigger
    removeCouponBtn.addEventListener('click', function() {
        const url = new URL(window.location.href);
        url.searchParams.set('coupon', '');
        window.location.href = url.toString();
    });

    // Allow Enter key to apply coupon
    couponInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !appliedCouponCode) {
            e.preventDefault();
            applyCouponBtn.click();
        }
    });

    // Public coupon chip click — reload with coupon applied
    document.querySelectorAll('.public-coupon-chip').forEach(function(chip) {
        chip.addEventListener('click', function() {
            const code = this.dataset.code;
            const url = new URL(window.location.href);
            url.searchParams.set('coupon', code);
            window.location.href = url.toString();
        });
    });

    const options = {
        "key": "{{ razorpay_key_id }}",
        "amount": "{{ amount_paise }}",
        "currency": "{{ currency }}",
        "name": "MaedixQ",
        "description": "{{ plan.name }} Plan - {% if is_yearly %}Yearly{% else %}Monthly{% endif %}",
        "order_id": "{{ order_id }}",
        "handler": function(response) {
            // Payment successful - submit to backend
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{% url "payment_success" %}';

            const inputs = {
                'razorpay_payment_id': response.razorpay_payment_id,
                'razorpay_order_id': response.razorpay_order_id,
                'razorpay_signature': response.razorpay_signature,
                'plan_slug': '{{ plan.slug }}',
                'billing': '{{ billing }}',
                'coupon_code': appliedCouponCode,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            };

            Object.keys(inputs).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = inputs[key];
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
        },
        "prefill": {
            "name": "{{ user.get_full_name|default:user.username }}",
            "email": "{{ user.email }}"
        },
        "notes": {
            "plan_slug": "{{ plan.slug }}",
            "billing": "{{ billing }}"
        },
        "theme": {
            "color": "#6366f1"
        },
        "modal": {
            "ondismiss": function() {
                btnText.classList.remove('d-none');
                spinner.classList.add('d-none');
                rzpButton.disabled = false;
            }
        }
    };

    const rzp = new Razorpay(options);

    rzp.on('payment.failed', function(response) {
        btnText.classList.remove('d-none');
        spinner.classList.add('d-none');
        rzpButton.disabled = false;

        alert('Payment Failed: ' + response.error.description);

        // Log failure to backend
        fetch('{% url "payment_failed" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                error_code: response.error.code,
                error_description: response.error.description,
                order_id: response.error.metadata.order_id,
                payment_id: response.error.metadata.payment_id
            })
        });
    });

    rzpButton.onclick = function(e) {
        e.preventDefault();
        btnText.classList.add('d-none');
        spinner.classList.remove('d-none');
        rzpButton.disabled = true;
        rzp.open();
    };
});
</script>
{% endblock %}
