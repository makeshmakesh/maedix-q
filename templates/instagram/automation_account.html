{% extends 'base.html' %}
{% load subscription_tags %}

{% block title %}Account Automation Settings{% endblock %}

{% block extra_css %}
<style>
    .message-input-group {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        align-items: flex-start;
    }

    .message-input-group textarea {
        flex: 1;
        min-height: 80px;
        font-size: 1rem;
        padding: 0.75rem;
    }

    .message-input-group .btn-remove-msg {
        padding: 0.5rem 0.625rem;
        flex-shrink: 0;
    }

    .message-input-group .msg-number {
        width: 24px;
        height: 24px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        flex-shrink: 0;
        margin-top: 0.5rem;
    }

    #addReplyBtn:disabled, #addDmBtn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Mobile: larger textareas, number on top */
    @media (max-width: 575.98px) {
        .message-input-group {
            flex-wrap: wrap;
            position: relative;
        }
        .message-input-group .msg-number {
            position: absolute;
            top: -8px;
            left: 8px;
            width: 20px;
            height: 20px;
            font-size: 0.65rem;
            z-index: 1;
        }
        .message-input-group textarea {
            width: 100%;
            flex: 1 1 calc(100% - 45px);
            min-height: 100px;
            font-size: 16px;
            padding: 0.875rem;
        }
        .message-input-group .btn-remove-msg {
            padding: 0.5rem 0.625rem;
            align-self: flex-start;
            margin-top: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<section class="py-4 py-md-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb small">
                        <li class="breadcrumb-item"><a href="{% url 'flow_list' %}">Automation</a></li>
                        <li class="breadcrumb-item active">Account Settings</li>
                    </ol>
                </nav>

                <div class="card p-4">
                    <div class="text-center mb-4">
                        <i class="bi bi-gear text-primary" style="font-size: 2.5rem;"></i>
                        <h3 class="fw-bold mt-3">Account-Level Automation</h3>
                        <p class="text-muted">
                            Default automation for comments on posts without specific rules
                        </p>
                    </div>

                    <div class="alert alert-info mb-4">
                        <h6 class="fw-bold mb-2"><i class="bi bi-info-circle me-1"></i>How Account-Level Automation Works</h6>
                        <p class="mb-0 small">
                            When a comment comes in on any of your posts:
                        </p>
                        <ol class="small mb-0 mt-2">
                            <li>First, the system checks if any post-level automation matches</li>
                            <li>If no match is found and account-level automation is enabled, these default replies are sent</li>
                            <li>This acts as a fallback for posts without specific automations</li>
                        </ol>
                    </div>

                    <form method="post" id="accountForm">
                        {% csrf_token %}

                        <!-- Enable/Disable Toggle -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="account_automation_enabled"
                                       name="account_automation_enabled"
                                       {% if instagram_account.account_automation_enabled %}checked{% endif %}>
                                <label class="form-check-label fw-bold" for="account_automation_enabled">
                                    Enable Account-Level Automation
                                </label>
                            </div>
                            <small class="text-muted">
                                When enabled, comments on posts without specific automations will get these default replies
                            </small>
                        </div>

                        <hr class="my-4">

                        <!-- Default Comment Replies (Multiple) -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-chat-left-text me-1"></i>Default Comment Replies
                                <span class="badge bg-info ms-1">1-5 variations</span>
                            </label>
                            <p class="text-muted small mb-2">Add multiple reply variations. One will be randomly selected. <strong>At least 1 required to enable automation.</strong></p>
                            <div id="commentRepliesContainer"></div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addReplyBtn">
                                <i class="bi bi-plus-circle me-1"></i>Add Reply Variation
                            </button>
                            <small class="text-muted d-block mt-2">
                                Public reply posted under comments on posts without specific automations.
                            </small>
                        </div>

                        <!-- Default Follow-up DMs (Multiple) -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-envelope me-1"></i>Default Follow-up DMs
                                <span class="badge bg-secondary ms-1">0-5 variations</span>
                            </label>
                            <p class="text-muted small mb-2">Add DM variations. One will be randomly selected. <strong>Leave all empty to skip DMs.</strong></p>
                            <div id="followupDmsContainer"></div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addDmBtn">
                                <i class="bi bi-plus-circle me-1"></i>Add DM Variation
                            </button>
                            <small class="text-muted d-block mt-2">
                                Private message sent to commenters after comment reply. Optional.
                            </small>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-lg me-2"></i>Save Settings
                            </button>
                            <a href="{% url 'flow_list' %}" class="btn btn-outline-secondary">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>

                <div class="card mt-4">
                    <div class="card-body">
                        <h6 class="fw-bold"><i class="bi bi-instagram me-2"></i>Connected Account</h6>
                        <p class="mb-0">
                            <strong>{{ instagram_account }}</strong>
                            <br>
                            <small class="text-muted">
                                Automation will apply to comments on this account's posts
                            </small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
(function() {
    var existingReplies = {% if instagram_account.account_comment_replies %}{{ instagram_account.account_comment_replies|jsonify }}{% else %}[]{% endif %};
    var existingDms = {% if instagram_account.account_followup_dms %}{{ instagram_account.account_followup_dms|jsonify }}{% else %}[]{% endif %};

    document.addEventListener('DOMContentLoaded', function() {
        var repliesContainer = document.getElementById('commentRepliesContainer');
        var dmsContainer = document.getElementById('followupDmsContainer');
        var addReplyBtn = document.getElementById('addReplyBtn');
        var addDmBtn = document.getElementById('addDmBtn');
        var enabledCheckbox = document.getElementById('account_automation_enabled');
        var MAX_MESSAGES = 5;

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function createMessageInput(container, name, index, value, placeholder, isReply) {
            var div = document.createElement('div');
            div.className = 'message-input-group';

            div.innerHTML = '<span class="msg-number">' + (index + 1) + '</span>' +
                '<textarea class="form-control" name="' + name + '[]" rows="2" placeholder="' + placeholder + '">' + escapeHtml(value || '') + '</textarea>' +
                '<button type="button" class="btn btn-outline-danger btn-sm btn-remove-msg" title="Remove"><i class="bi bi-trash"></i></button>';

            div.querySelector('.btn-remove-msg').addEventListener('click', function() {
                // Don't allow removing the last reply
                if (isReply && repliesContainer.children.length <= 1) {
                    alert('At least one comment reply is required.');
                    return;
                }
                div.remove();
                updateMessageNumbers(container);
                updateAddButtons();
            });

            container.appendChild(div);
            updateAddButtons();
        }

        function updateMessageNumbers(container) {
            var groups = container.querySelectorAll('.message-input-group');
            for (var i = 0; i < groups.length; i++) {
                groups[i].querySelector('.msg-number').textContent = i + 1;
            }
        }

        function updateAddButtons() {
            addReplyBtn.disabled = repliesContainer.children.length >= MAX_MESSAGES;
            addDmBtn.disabled = dmsContainer.children.length >= MAX_MESSAGES;
        }

        // Initialize replies - always show at least one
        if (existingReplies && existingReplies.length > 0) {
            for (var i = 0; i < existingReplies.length; i++) {
                createMessageInput(repliesContainer, 'account_comment_replies', i, existingReplies[i], 'e.g., Thanks for your comment! Check your DMs for more info.', true);
            }
        } else {
            createMessageInput(repliesContainer, 'account_comment_replies', 0, '', 'e.g., Thanks for your comment! Check your DMs for more info.', true);
        }

        // Initialize DMs
        if (existingDms && existingDms.length > 0) {
            for (var j = 0; j < existingDms.length; j++) {
                createMessageInput(dmsContainer, 'account_followup_dms', j, existingDms[j], 'e.g., Hey! Thanks for reaching out. How can I help you today?', false);
            }
        }

        addReplyBtn.addEventListener('click', function() {
            if (repliesContainer.children.length < MAX_MESSAGES) {
                createMessageInput(repliesContainer, 'account_comment_replies', repliesContainer.children.length, '', 'e.g., Thanks for your comment! Check your DMs for more info.', true);
            }
        });

        addDmBtn.addEventListener('click', function() {
            if (dmsContainer.children.length < MAX_MESSAGES) {
                createMessageInput(dmsContainer, 'account_followup_dms', dmsContainer.children.length, '', 'e.g., Hey! Thanks for reaching out. How can I help you today?', false);
            }
        });

        // Form validation
        document.getElementById('accountForm').addEventListener('submit', function(e) {
            // If enabling automation, require at least one comment reply
            if (enabledCheckbox.checked) {
                var replyTextareas = repliesContainer.querySelectorAll('textarea');
                var hasValidReply = false;
                for (var i = 0; i < replyTextareas.length; i++) {
                    if (replyTextareas[i].value.trim()) {
                        hasValidReply = true;
                        break;
                    }
                }
                if (!hasValidReply) {
                    e.preventDefault();
                    alert('Please add at least one comment reply to enable automation.');
                    return false;
                }
            }
        });
    });
})();
</script>
{% endblock %}
