{% extends 'base.html' %}

{% block title %}Account Automation Settings{% endblock %}

{% block content %}
<section class="py-4 py-md-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb small">
                        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'instagram_automation_list' %}">Automation</a></li>
                        <li class="breadcrumb-item active">Account Settings</li>
                    </ol>
                </nav>

                <div class="card p-4">
                    <div class="text-center mb-4">
                        <i class="bi bi-gear text-primary" style="font-size: 2.5rem;"></i>
                        <h3 class="fw-bold mt-3">Account-Level Automation</h3>
                        <p class="text-muted">
                            Default automation for comments on posts without specific rules
                        </p>
                    </div>

                    {% if messages %}
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                    {% endif %}

                    <!-- Info Alert -->
                    <div class="alert alert-info mb-4">
                        <h6 class="fw-bold mb-2"><i class="bi bi-info-circle me-1"></i>How Account-Level Automation Works</h6>
                        <p class="mb-0 small">
                            When a comment comes in on any of your posts:
                        </p>
                        <ol class="small mb-0 mt-2">
                            <li>First, the system checks if any post-level automation matches</li>
                            <li>If no match is found and account-level automation is enabled, these default replies are sent</li>
                            <li>This acts as a fallback for posts without specific automations</li>
                        </ol>
                    </div>

                    <form method="post">
                        {% csrf_token %}

                        <!-- Enable/Disable Toggle -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="account_automation_enabled"
                                       name="account_automation_enabled"
                                       {% if instagram_account.account_automation_enabled %}checked{% endif %}>
                                <label class="form-check-label fw-bold" for="account_automation_enabled">
                                    Enable Account-Level Automation
                                </label>
                            </div>
                            <small class="text-muted">
                                When enabled, comments on posts without specific automations will get these default replies
                            </small>
                        </div>

                        <hr class="my-4">

                        <!-- Default Comment Reply -->
                        <div class="mb-3">
                            <label for="account_comment_reply" class="form-label fw-bold">
                                <i class="bi bi-chat-left-text me-1"></i>Default Comment Reply
                            </label>
                            <textarea class="form-control" id="account_comment_reply" name="account_comment_reply"
                                      rows="3" placeholder="e.g., Thanks for your comment! Check your DMs for more info.">{{ instagram_account.account_comment_reply }}</textarea>
                            <small class="text-muted">
                                Public reply posted under comments (leave empty to skip comment replies)
                            </small>
                        </div>

                        <!-- Default Follow-up DM -->
                        <div class="mb-4">
                            <label for="account_followup_dm" class="form-label fw-bold">
                                <i class="bi bi-envelope me-1"></i>Default Follow-up DM
                            </label>
                            <textarea class="form-control" id="account_followup_dm" name="account_followup_dm"
                                      rows="4" placeholder="e.g., Hey! Thanks for reaching out. How can I help you today?">{{ instagram_account.account_followup_dm }}</textarea>
                            <small class="text-muted">
                                Private message sent to commenters (leave empty to skip DMs)
                            </small>
                        </div>

                        <hr class="my-4">

                        <!-- Follow Check Section -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="account_require_follow" name="account_require_follow"
                                       {% if instagram_account.account_require_follow %}checked{% endif %}
                                       onchange="toggleAccountFollowRequestMessage()">
                                <label class="form-check-label fw-bold" for="account_require_follow">
                                    <i class="bi bi-person-plus me-1"></i>Require Follow Before Sending DM
                                </label>
                            </div>
                            <small class="text-muted">
                                If enabled, users must follow you before receiving the follow-up DM
                            </small>
                        </div>

                        <!-- Follow Request Message -->
                        <div class="mb-4" id="accountFollowRequestSection" style="display: none;">
                            <label for="account_follow_request_message" class="form-label fw-bold">
                                <i class="bi bi-chat-heart me-1"></i>Follow Request Message
                            </label>
                            <textarea class="form-control" id="account_follow_request_message" name="account_follow_request_message"
                                      rows="4" placeholder="e.g., Hey! To get the exclusive content, please follow our page first and tap 'I Followed' below.">{{ instagram_account.account_follow_request_message }}</textarea>
                            <small class="text-muted">
                                Message sent to non-followers. They'll see an "I Followed" button to confirm and receive the DM.
                            </small>

                            <div class="alert alert-light mt-3 small">
                                <i class="bi bi-info-circle me-1"></i>
                                <strong>How it works:</strong> Non-followers receive this message with an "I Followed" button.
                                When they click it, they'll receive the follow-up DM above.
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-lg me-2"></i>Save Settings
                            </button>
                            <a href="{% url 'instagram_automation_list' %}" class="btn btn-outline-secondary">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>

                <!-- Account Info Card -->
                <div class="card mt-4">
                    <div class="card-body">
                        <h6 class="fw-bold"><i class="bi bi-instagram me-2"></i>Connected Account</h6>
                        <p class="mb-0">
                            <strong>{{ instagram_account }}</strong>
                            <br>
                            <small class="text-muted">
                                Automation will apply to comments on this account's posts
                            </small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
function toggleAccountFollowRequestMessage() {
    const checkbox = document.getElementById('account_require_follow');
    const section = document.getElementById('accountFollowRequestSection');

    if (checkbox.checked) {
        section.style.display = 'block';
    } else {
        section.style.display = 'none';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleAccountFollowRequestMessage();
});
</script>
{% endblock %}
