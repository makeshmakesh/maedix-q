{% extends 'base.html' %}
{% load subscription_tags %}

{% block title %}{% if editing %}Edit{% else %}Create{% endif %} Automation{% endblock %}

{% block content %}
<style>
    /* Post Browser Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1050;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content-custom {
        background: var(--bg-white);
        border-radius: 16px;
        max-width: 900px;
        width: 100%;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    @media (max-width: 575.98px) {
        .modal-content-custom {
            border-radius: 12px 12px 0 0;
            max-height: 85vh;
            margin-top: auto;
        }
        .modal-overlay {
            align-items: flex-end;
            padding: 0;
        }
    }

    .modal-header-custom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-header-custom h5 {
        margin: 0;
        font-weight: 600;
    }

    .modal-body-custom {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
    }

    .btn-close-modal {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-muted);
        line-height: 1;
    }

    .btn-close-modal:hover {
        color: var(--text-dark);
    }

    /* Posts Grid */
    .posts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    @media (min-width: 576px) {
        .posts-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }
    }

    .post-card {
        border: 2px solid var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
        background: var(--bg-white);
    }

    .post-card:hover {
        border-color: var(--primary);
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(99, 102, 241, 0.2);
    }

    .post-card.selected {
        border-color: var(--secondary);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }

    .post-card img {
        width: 100%;
        aspect-ratio: 1;
        object-fit: cover;
    }

    .post-card .post-info {
        padding: 0.5rem;
    }

    .post-card .post-caption {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .post-card .post-date {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin: 0.25rem 0 0;
    }

    /* Selected Post Preview */
    .selected-post-preview {
        display: none;
        margin-top: 0.75rem;
        padding: 0.75rem;
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 8px;
    }

    .selected-post-preview.show {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .selected-post-preview img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
    }

    /* Instagram Post Input Group */
    .instagram-input-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    @media (min-width: 576px) {
        .instagram-input-group {
            flex-direction: row;
        }
        .instagram-input-group input {
            flex: 1;
        }
    }

    .btn-browse-posts {
        white-space: nowrap;
    }

    /* Keyword Tag Input */
    .keyword-input-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-white);
        min-height: 50px;
        align-items: center;
        transition: all 0.3s ease;
        cursor: text;
    }

    .keyword-input-container:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .keyword-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .keyword-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.625rem;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        color: white;
    }

    .keyword-tag .tag-remove {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        cursor: pointer;
        font-size: 0.75rem;
    }

    .keyword-tag .tag-remove:hover {
        background: rgba(255, 255, 255, 0.4);
    }

    .keyword-input {
        flex: 1;
        min-width: 120px;
        border: none;
        background: transparent;
        color: var(--text-dark);
        font-size: 0.95rem;
        outline: none;
        padding: 0.25rem;
    }

    .keyword-suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.75rem;
        align-items: center;
    }

    .suggestion-label {
        font-size: 0.8rem;
        color: var(--text-muted);
        width: 100%;
    }

    @media (min-width: 576px) {
        .suggestion-label {
            width: auto;
        }
    }

    .keyword-suggestion {
        padding: 0.3rem 0.6rem;
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 15px;
        color: var(--text-muted);
        font-size: 0.8rem;
        cursor: pointer;
    }

    .keyword-suggestion:hover {
        background: rgba(99, 102, 241, 0.2);
        color: var(--text-dark);
    }

    .keyword-suggestion.added {
        background: rgba(16, 185, 129, 0.15);
        border-color: rgba(16, 185, 129, 0.3);
        color: var(--secondary);
    }

    /* Loading State */
    .loading-state {
        text-align: center;
        padding: 3rem;
    }

    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid var(--border-color);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .error-state, .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--text-muted);
    }

    /* Multiple Message Inputs */
    .message-input-group {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        align-items: flex-start;
    }

    .message-input-group textarea {
        flex: 1;
        min-height: 80px;
        font-size: 1rem;
        padding: 0.75rem;
    }

    .message-input-group .btn-remove-msg {
        padding: 0.5rem 0.625rem;
        flex-shrink: 0;
    }

    .message-input-group .msg-number {
        width: 24px;
        height: 24px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        flex-shrink: 0;
        margin-top: 0.5rem;
    }

    #addReplyBtn:disabled, #addDmBtn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Mobile: larger textareas, number on top */
    @media (max-width: 575.98px) {
        .message-input-group {
            flex-wrap: wrap;
            position: relative;
        }
        .message-input-group .msg-number {
            position: absolute;
            top: -8px;
            left: 8px;
            width: 20px;
            height: 20px;
            font-size: 0.65rem;
            z-index: 1;
        }
        .message-input-group textarea {
            width: 100%;
            flex: 1 1 calc(100% - 45px);
            min-height: 100px;
            font-size: 16px;
            padding: 0.875rem;
        }
        .message-input-group .btn-remove-msg {
            padding: 0.5rem 0.625rem;
            align-self: flex-start;
            margin-top: 0.5rem;
        }
    }
</style>

<section class="py-4 py-md-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb small">
                        <li class="breadcrumb-item"><a href="{% url 'flow_list' %}">Automation</a></li>
                        <li class="breadcrumb-item active">{% if editing %}Edit{% else %}Create{% endif %}</li>
                    </ol>
                </nav>

                <div class="card p-4">
                    <div class="text-center mb-4">
                        <i class="bi bi-robot text-primary" style="font-size: 2.5rem;"></i>
                        <h3 class="fw-bold mt-3">
                            {% if editing %}Edit Automation{% else %}Create Automation{% endif %}
                        </h3>
                        <p class="text-muted">Set up keyword triggers and auto-replies for a specific Instagram post</p>
                    </div>

                    {% if messages %}
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                    {% endif %}

                    <div class="alert alert-info mb-4">
                        <h6 class="fw-bold mb-2"><i class="bi bi-info-circle me-1"></i>Post-Level vs Account-Level Automation</h6>
                        <p class="mb-0 small">
                            This form creates automation for a <strong>specific post</strong>. For posts without specific automations,
                            use <a href="{% url 'instagram_automation_account' %}">Account-Level Automation</a> as a fallback.
                        </p>
                    </div>

                    <form method="post" id="automationForm">
                        {% csrf_token %}

                        <!-- Title -->
                        <div class="mb-3">
                            <label for="title" class="form-label fw-bold">
                                <i class="bi bi-tag me-1"></i>Automation Title
                            </label>
                            <input type="text" class="form-control" id="title" name="title"
                                   value="{{ automation.title|default:'' }}"
                                   placeholder="e.g., My Automation" maxlength="100" required>
                            <small class="text-muted">Give your automation a descriptive name</small>
                        </div>

                        <!-- Instagram Post Selection -->
                        <div class="mb-3">
                            <label for="instagram_post_id" class="form-label fw-bold">
                                <i class="bi bi-image me-1"></i>Instagram Post
                                <span class="text-danger">*</span>
                            </label>
                            <div class="instagram-input-group">
                                <input type="text" class="form-control" id="instagram_post_id" name="instagram_post_id"
                                       value="{{ automation.instagram_post_id|default:'' }}"
                                       placeholder="Select from your Instagram posts" readonly required>
                                <button type="button" class="btn btn-outline-primary btn-browse-posts" id="browsePostsBtn">
                                    <i class="bi bi-grid me-1"></i>Browse Posts
                                </button>
                            </div>
                            <div class="selected-post-preview" id="selectedPostPreview">
                                <img id="previewImage" src="" alt="Post preview">
                                <div>
                                    <p class="mb-0 text-success fw-bold"><i class="bi bi-check-circle me-1"></i>Post Selected</p>
                                    <p id="previewCaption" class="text-muted small mb-0"></p>
                                </div>
                            </div>
                            <small class="text-muted">Select the post where this automation will be active</small>
                        </div>

                        <!-- Keywords -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-key me-1"></i>Trigger Keywords
                                <span class="badge bg-secondary ms-1">Optional</span>
                            </label>
                            <div class="keyword-input-container" id="keywordContainer">
                                <div class="keyword-tags" id="keywordTags"></div>
                                <input type="text" class="keyword-input" id="keywordInput"
                                       placeholder="Type keyword and press Enter...">
                            </div>
                            <input type="hidden" name="keywords" id="keywordHidden"
                                   value="{{ automation.keywords|default:'' }}">

                            <div class="keyword-suggestions">
                                <span class="suggestion-label">Quick add:</span>
                                <button type="button" class="keyword-suggestion" data-keyword="interested">interested</button>
                                <button type="button" class="keyword-suggestion" data-keyword="link">link</button>
                                <button type="button" class="keyword-suggestion" data-keyword="send">send</button>
                                <button type="button" class="keyword-suggestion" data-keyword="dm">dm</button>
                                <button type="button" class="keyword-suggestion" data-keyword="price">price</button>
                                <button type="button" class="keyword-suggestion" data-keyword="info">info</button>
                                <button type="button" class="keyword-suggestion" data-keyword="details">details</button>
                            </div>
                            <small class="text-muted">
                                Add keywords that trigger this automation. <strong>Leave empty to reply to every comment</strong> on this post.
                            </small>
                        </div>

                        <hr class="my-4">

                        <!-- Comment Replies (Multiple) -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-chat-left-text me-1"></i>Comment Replies
                                <span class="badge bg-info ms-1">1-5 variations</span>
                            </label>
                            <p class="text-muted small mb-2">Add multiple reply variations. One will be randomly selected each time to feel more natural.</p>
                            <div id="commentRepliesContainer"></div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addReplyBtn">
                                <i class="bi bi-plus-circle me-1"></i>Add Another Reply
                            </button>
                            <small class="text-muted d-block mt-2">
                                Public reply posted under the user's comment. At least 1 required.
                            </small>
                        </div>

                        <!-- Follow-up DMs (Multiple) -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-envelope me-1"></i>Follow-up DMs
                                <span class="badge bg-secondary ms-1">0-5 variations</span>
                            </label>
                            <p class="text-muted small mb-2">Add DM variations. One will be randomly selected. <strong>Leave empty to skip sending DMs.</strong></p>
                            <div id="followupDmsContainer"></div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addDmBtn">
                                <i class="bi bi-plus-circle me-1"></i>Add Another DM
                            </button>
                            <small class="text-muted d-block mt-2">
                                Private message sent to the commenter. Optional - leave all empty to skip DMs.
                            </small>
                        </div>

                        {% if editing %}
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="is_active" name="is_active"
                                       {% if automation.is_active %}checked{% endif %}>
                                <label class="form-check-label fw-bold" for="is_active">
                                    Automation Active
                                </label>
                            </div>
                            <small class="text-muted">Disable to pause this automation without deleting it</small>
                        </div>
                        {% endif %}

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-lg me-2"></i>
                                {% if editing %}Save Changes{% else %}Create Automation{% endif %}
                            </button>
                            <a href="{% url 'flow_list' %}" class="btn btn-outline-secondary">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>

                <div class="card mt-4">
                    <div class="card-body">
                        <h6 class="fw-bold"><i class="bi bi-question-circle me-2"></i>Tips for Effective Automations</h6>
                        <ul class="small text-muted mb-0">
                            <li class="mb-1">Use common request keywords like "link", "send", "dm", "interested"</li>
                            <li class="mb-1">Keep comment replies short and friendly (visible to everyone)</li>
                            <li class="mb-1">Include the actual content/link in your DM message</li>
                            <li>Create separate automations for different posts or campaigns</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Instagram Posts Modal -->
<div class="modal-overlay" id="instagramModal">
    <div class="modal-content-custom">
        <div class="modal-header-custom">
            <h5><i class="bi bi-instagram me-2"></i>Select Instagram Post</h5>
            <button type="button" class="btn-close-modal" id="closeModalBtn">&times;</button>
        </div>
        <div class="modal-body-custom" id="modalBody">
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <p>Loading your Instagram posts...</p>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // Data from Django
    var existingReplies = {% if editing and automation.comment_replies %}{{ automation.comment_replies|jsonify }}{% else %}[]{% endif %};
    var existingDms = {% if editing and automation.followup_dms %}{{ automation.followup_dms|jsonify }}{% else %}[]{% endif %};

    document.addEventListener('DOMContentLoaded', function() {
        var repliesContainer = document.getElementById('commentRepliesContainer');
        var dmsContainer = document.getElementById('followupDmsContainer');
        var addReplyBtn = document.getElementById('addReplyBtn');
        var addDmBtn = document.getElementById('addDmBtn');
        var MAX_MESSAGES = 5;

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function createMessageInput(container, name, index, value, isReply) {
            var div = document.createElement('div');
            div.className = 'message-input-group';
            var placeholder = isReply ? 'e.g., Thanks for your interest! Check your DMs.' : 'e.g., Hey! Here\'s the link you requested: https://...';
            var requiredAttr = (isReply && index === 0) ? 'required' : '';

            div.innerHTML = '<span class="msg-number">' + (index + 1) + '</span>' +
                '<textarea class="form-control" name="' + name + '[]" rows="2" placeholder="' + placeholder + '" ' + requiredAttr + '>' + escapeHtml(value || '') + '</textarea>' +
                '<button type="button" class="btn btn-outline-danger btn-sm btn-remove-msg" title="Remove"><i class="bi bi-trash"></i></button>';

            div.querySelector('.btn-remove-msg').addEventListener('click', function() {
                if (isReply && repliesContainer.children.length <= 1) {
                    alert('At least one comment reply is required.');
                    return;
                }
                div.remove();
                updateMessageNumbers(container);
                updateAddButtons();
            });

            container.appendChild(div);
            updateAddButtons();
        }

        function updateMessageNumbers(container) {
            var groups = container.querySelectorAll('.message-input-group');
            for (var i = 0; i < groups.length; i++) {
                groups[i].querySelector('.msg-number').textContent = i + 1;
                var textarea = groups[i].querySelector('textarea');
                if (container === repliesContainer && i === 0) {
                    textarea.required = true;
                }
            }
        }

        function updateAddButtons() {
            addReplyBtn.disabled = repliesContainer.children.length >= MAX_MESSAGES;
            addDmBtn.disabled = dmsContainer.children.length >= MAX_MESSAGES;
        }

        // Initialize replies
        if (existingReplies && existingReplies.length > 0) {
            for (var i = 0; i < existingReplies.length; i++) {
                createMessageInput(repliesContainer, 'comment_replies', i, existingReplies[i], true);
            }
        } else {
            createMessageInput(repliesContainer, 'comment_replies', 0, '', true);
        }

        // Initialize DMs
        if (existingDms && existingDms.length > 0) {
            for (var j = 0; j < existingDms.length; j++) {
                createMessageInput(dmsContainer, 'followup_dms', j, existingDms[j], false);
            }
        }

        addReplyBtn.addEventListener('click', function() {
            if (repliesContainer.children.length < MAX_MESSAGES) {
                createMessageInput(repliesContainer, 'comment_replies', repliesContainer.children.length, '', true);
            }
        });

        addDmBtn.addEventListener('click', function() {
            if (dmsContainer.children.length < MAX_MESSAGES) {
                createMessageInput(dmsContainer, 'followup_dms', dmsContainer.children.length, '', false);
            }
        });

        // ========== Keyword Tag Input ==========
        var keywordInput = document.getElementById('keywordInput');
        var keywordTags = document.getElementById('keywordTags');
        var keywordHidden = document.getElementById('keywordHidden');
        var keywordSuggestions = document.querySelectorAll('.keyword-suggestion');
        var keywordContainer = document.getElementById('keywordContainer');
        var keywords = [];

        if (keywordHidden.value) {
            keywordHidden.value.split(',').forEach(function(kw) {
                var trimmed = kw.trim();
                if (trimmed) keywords.push(trimmed.toLowerCase());
            });
            renderTags();
            updateSuggestionButtons();
        }

        function normalizeKeyword(keyword) {
            return keyword.trim().toLowerCase().replace(/\s+/g, ' ');
        }

        function addKeyword(keyword) {
            var normalized = normalizeKeyword(keyword);
            if (!normalized || normalized.length < 2 || normalized.length > 50) return false;
            if (keywords.indexOf(normalized) !== -1) return false;

            keywords.push(normalized);
            renderTags();
            updateHiddenInput();
            updateSuggestionButtons();
            return true;
        }

        function removeKeyword(keyword) {
            keywords = keywords.filter(function(k) { return k !== keyword; });
            renderTags();
            updateHiddenInput();
            updateSuggestionButtons();
        }

        function renderTags() {
            keywordTags.innerHTML = keywords.map(function(keyword) {
                return '<span class="keyword-tag"><span>' + escapeHtml(keyword) + '</span><span class="tag-remove" data-keyword="' + escapeHtml(keyword) + '">&times;</span></span>';
            }).join('');

            keywordTags.querySelectorAll('.tag-remove').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    removeKeyword(this.dataset.keyword);
                });
            });
        }

        function updateHiddenInput() {
            keywordHidden.value = keywords.join(', ');
        }

        function updateSuggestionButtons() {
            keywordSuggestions.forEach(function(btn) {
                var keyword = normalizeKeyword(btn.dataset.keyword);
                if (keywords.indexOf(keyword) !== -1) {
                    btn.classList.add('added');
                    btn.innerHTML = '<i class="bi bi-check"></i> ' + btn.dataset.keyword;
                } else {
                    btn.classList.remove('added');
                    btn.textContent = btn.dataset.keyword;
                }
            });
        }

        keywordInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                var value = this.value.trim();
                if (value) {
                    value.split(',').forEach(function(kw) { addKeyword(kw); });
                    this.value = '';
                }
            } else if (e.key === 'Backspace' && !this.value && keywords.length > 0) {
                removeKeyword(keywords[keywords.length - 1]);
            }
        });

        keywordInput.addEventListener('paste', function(e) {
            e.preventDefault();
            var pasted = (e.clipboardData || window.clipboardData).getData('text');
            pasted.split(',').forEach(function(kw) { addKeyword(kw); });
        });

        keywordInput.addEventListener('blur', function() {
            if (this.value.trim()) {
                addKeyword(this.value);
                this.value = '';
            }
        });

        keywordSuggestions.forEach(function(btn) {
            btn.addEventListener('click', function() {
                var keyword = this.dataset.keyword;
                var normalized = normalizeKeyword(keyword);
                if (keywords.indexOf(normalized) !== -1) {
                    removeKeyword(normalized);
                } else {
                    addKeyword(keyword);
                }
            });
        });

        keywordContainer.addEventListener('click', function() {
            keywordInput.focus();
        });

        // ========== Instagram Posts Modal ==========
        var modal = document.getElementById('instagramModal');
        var browseBtn = document.getElementById('browsePostsBtn');
        var closeBtn = document.getElementById('closeModalBtn');
        var modalBody = document.getElementById('modalBody');
        var postsData = {};

        browseBtn.addEventListener('click', function() {
            modal.classList.add('active');
            loadInstagramPosts();
        });

        closeBtn.addEventListener('click', function() {
            modal.classList.remove('active');
        });

        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });

        function loadInstagramPosts() {
            modalBody.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><p>Loading your Instagram posts...</p></div>';

            fetch('{% url "instagram_api_posts" %}')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (!data.success) {
                        modalBody.innerHTML = '<div class="error-state"><i class="bi bi-exclamation-triangle text-danger" style="font-size: 2rem;"></i><p class="mt-2">' + (data.error || 'Failed to load posts') + '</p></div>';
                        return;
                    }
                    if (!data.posts || data.posts.length === 0) {
                        modalBody.innerHTML = '<div class="empty-state"><i class="bi bi-inbox" style="font-size: 2rem;"></i><p class="mt-2">No posts found</p></div>';
                        return;
                    }
                    renderPosts(data.posts);
                })
                .catch(function() {
                    modalBody.innerHTML = '<div class="error-state"><i class="bi bi-exclamation-triangle text-danger" style="font-size: 2rem;"></i><p class="mt-2">Network error</p></div>';
                });
        }

        function renderPosts(posts) {
            var currentPostId = document.getElementById('instagram_post_id').value;
            postsData = {};
            posts.forEach(function(post) { postsData[post.id] = post; });

            var html = '<div class="posts-grid">';
            posts.forEach(function(post) {
                var imageUrl = post.media_type === 'VIDEO' ? (post.thumbnail_url || post.media_url) : post.media_url;
                var caption = post.caption ? post.caption.substring(0, 40) + '...' : 'No caption';
                var date = new Date(post.timestamp).toLocaleDateString();
                var selected = currentPostId === post.id ? 'selected' : '';
                html += '<div class="post-card ' + selected + '" data-post-id="' + post.id + '">' +
                    '<img src="' + imageUrl + '" alt="Post" onerror="this.src=\'https://via.placeholder.com/200?text=No+Image\'">' +
                    '<div class="post-info"><p class="post-caption">' + escapeHtml(caption) + '</p><p class="post-date">' + date + '</p></div></div>';
            });
            html += '</div>';
            modalBody.innerHTML = html;

            document.querySelectorAll('.post-card').forEach(function(card) {
                card.addEventListener('click', function() { selectPost(this); });
            });
        }

        function selectPost(cardElement) {
            document.querySelectorAll('.post-card').forEach(function(c) { c.classList.remove('selected'); });
            cardElement.classList.add('selected');

            var postId = cardElement.dataset.postId;
            var postData = postsData[postId];

            document.getElementById('instagram_post_id').value = postData.id;

            var preview = document.getElementById('selectedPostPreview');
            var imageUrl = postData.media_type === 'VIDEO' ? (postData.thumbnail_url || postData.media_url) : postData.media_url;
            document.getElementById('previewImage').src = imageUrl;
            document.getElementById('previewCaption').textContent = postData.caption ? postData.caption.substring(0, 60) + '...' : 'No caption';
            preview.classList.add('show');

            setTimeout(function() { modal.classList.remove('active'); }, 400);
        }

        // Form validation
        document.getElementById('automationForm').addEventListener('submit', function(e) {
            if (!document.getElementById('instagram_post_id').value) {
                e.preventDefault();
                alert('Please select an Instagram post.');
                return false;
            }

            var replyTextareas = repliesContainer.querySelectorAll('textarea');
            var hasValidReply = false;
            for (var i = 0; i < replyTextareas.length; i++) {
                if (replyTextareas[i].value.trim()) {
                    hasValidReply = true;
                    break;
                }
            }
            if (!hasValidReply) {
                e.preventDefault();
                alert('Please add at least one comment reply.');
                return false;
            }
        });
    });
})();
</script>
{% endblock %}
