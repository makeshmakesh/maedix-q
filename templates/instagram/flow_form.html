{% extends 'base.html' %}

{% block title %}Create Flow{% endblock %}

{% block extra_css %}
<style>
    /* Mobile-first styling */
    .flow-form-container {
        max-width: 600px;
        margin: 0 auto;
    }

    .flow-header {
        background: var(--gradient);
        color: white;
        padding: 1.5rem;
        border-radius: 0 0 1.5rem 1.5rem;
        margin: -1rem -12px 1.5rem -12px;
    }

    @media (min-width: 768px) {
        .flow-header {
            border-radius: 1rem;
            margin: 0 0 1.5rem 0;
        }
    }

    .flow-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
    }

    .flow-header p {
        opacity: 0.9;
        margin: 0.5rem 0 0 0;
        font-size: 0.9rem;
    }

    .section-card {
        background: white;
        border-radius: 1rem;
        padding: 1.25rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        border: 1px solid #f0f0f0;
    }

    .section-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-title i {
        font-size: 1rem;
    }

    /* Form inputs */
    .form-control, .form-select {
        border-radius: 0.75rem;
        padding: 0.875rem 1rem;
        font-size: 1rem;
        border: 2px solid #e9ecef;
        transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.15);
    }

    .form-control::placeholder {
        color: #adb5bd;
    }

    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .form-text {
        color: #6c757d;
        font-size: 0.8rem;
        margin-top: 0.5rem;
    }

    /* Trigger type cards */
    .trigger-options {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .trigger-option {
        position: relative;
        cursor: pointer;
    }

    .trigger-option input {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    .trigger-option-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        border: 2px solid #e9ecef;
        border-radius: 0.75rem;
        transition: all 0.2s ease;
        background: #fafafa;
    }

    .trigger-option input:checked + .trigger-option-card {
        border-color: var(--primary);
        background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.08) 0%, rgba(var(--primary-rgb), 0.08) 100%);
    }

    .trigger-option-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    .trigger-option input:checked + .trigger-option-card .trigger-option-icon {
        background: var(--gradient);
        color: white;
    }

    .trigger-option input:not(:checked) + .trigger-option-card .trigger-option-icon {
        background: #e9ecef;
        color: #6c757d;
    }

    .trigger-option-content h6 {
        font-weight: 600;
        margin: 0 0 0.25rem 0;
        font-size: 0.95rem;
        color: #212529;
    }

    .trigger-option-content p {
        margin: 0;
        font-size: 0.8rem;
        color: #6c757d;
    }

    .trigger-option-check {
        margin-left: auto;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s ease;
    }

    .trigger-option input:checked + .trigger-option-card .trigger-option-check {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }

    /* Keywords tag input styling */
    .keywords-container {
        border: 2px solid #e9ecef;
        border-radius: 0.75rem;
        padding: 0.5rem;
        min-height: 54px;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
        cursor: text;
        transition: all 0.2s ease;
        background: white;
    }

    .keywords-container:focus-within {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.15);
    }

    .keyword-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        background: var(--gradient);
        color: white;
        padding: 0.375rem 0.625rem;
        border-radius: 2rem;
        font-size: 0.85rem;
        font-weight: 500;
        animation: tagPop 0.2s ease;
    }

    @keyframes tagPop {
        0% { transform: scale(0.8); opacity: 0; }
        100% { transform: scale(1); opacity: 1; }
    }

    .keyword-tag .remove-tag {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        cursor: pointer;
        transition: all 0.15s ease;
        border: none;
        padding: 0;
        color: white;
        font-size: 0.7rem;
    }

    .keyword-tag .remove-tag:hover {
        background: rgba(255,255,255,0.4);
    }

    .keyword-input {
        flex: 1;
        min-width: 100px;
        border: none;
        outline: none;
        padding: 0.375rem 0.5rem;
        font-size: 1rem;
        background: transparent;
    }

    .keyword-input::placeholder {
        color: #adb5bd;
    }

    .quick-add-section {
        margin-top: 0.75rem;
    }

    .quick-add-label {
        font-size: 0.75rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
        display: block;
    }

    .quick-add-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .quick-add-btn {
        background: #f8f9fa;
        padding: 0.375rem 0.75rem;
        border-radius: 2rem;
        font-size: 0.8rem;
        color: #495057;
        border: 1px solid #e9ecef;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
    }

    .quick-add-btn:hover {
        background: #e9ecef;
        border-color: #dee2e6;
    }

    .quick-add-btn.added {
        background: rgba(var(--primary-rgb), 0.1);
        border-color: var(--primary);
        color: var(--primary);
    }

    .quick-add-btn i {
        font-size: 0.7rem;
    }

    /* Post selection */
    .post-select-btn {
        width: 100%;
        padding: 1rem;
        border: 2px dashed #dee2e6;
        border-radius: 0.75rem;
        background: #fafafa;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        color: #6c757d;
        font-weight: 500;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .post-select-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: rgba(var(--primary-rgb), 0.05);
    }

    .post-select-btn.has-post {
        border-style: solid;
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.05);
        color: #28a745;
    }

    .selected-post-preview {
        display: none;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 0.75rem;
        margin-top: 0.75rem;
    }

    .selected-post-preview.visible {
        display: flex;
    }

    .selected-post-preview img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 0.5rem;
    }

    .selected-post-info {
        flex: 1;
        min-width: 0;
    }

    .selected-post-info .post-id {
        font-size: 0.75rem;
        color: #6c757d;
        font-family: monospace;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .clear-post-btn {
        padding: 0.5rem;
        color: #dc3545;
        background: none;
        border: none;
        cursor: pointer;
    }

    /* Submit buttons */
    .form-actions {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-top: 1.5rem;
    }

    @media (min-width: 576px) {
        .form-actions {
            flex-direction: row;
        }
    }

    .btn-create {
        background: var(--gradient);
        border: none;
        color: white;
        padding: 1rem 2rem;
        border-radius: 0.75rem;
        font-weight: 600;
        font-size: 1rem;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
    }

    .btn-create:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.4);
        color: white;
    }

    .btn-cancel {
        padding: 1rem 1.5rem;
        border-radius: 0.75rem;
        font-weight: 500;
        border: 2px solid #e9ecef;
        background: white;
        color: #6c757d;
    }

    .btn-cancel:hover {
        border-color: #dee2e6;
        background: #f8f9fa;
    }

    /* Modal improvements */
    .modal-content {
        border-radius: 1rem;
        border: none;
    }

    .modal-header {
        border-bottom: 1px solid #f0f0f0;
        padding: 1rem 1.25rem;
    }

    .modal-body {
        padding: 1rem;
    }

    .post-item {
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid transparent !important;
        border-radius: 0.5rem !important;
        overflow: hidden;
    }

    .post-item:hover {
        border-color: var(--primary) !important;
        transform: scale(1.02);
    }

    .post-item img {
        border-radius: 0.375rem;
    }

    /* All posts badge */
    .all-posts-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        background: var(--gradient);
        color: white;
        padding: 0.375rem 0.75rem;
        border-radius: 2rem;
        font-size: 0.75rem;
        font-weight: 500;
    }

    /* Back button */
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: rgba(255,255,255,0.9);
        text-decoration: none;
        font-size: 0.9rem;
        margin-bottom: 0.75rem;
    }

    .back-link:hover {
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<section class="py-3 py-md-4">
    <div class="container">
        <div class="flow-form-container">
            <!-- Header -->
            <div class="flow-header">
                <a href="{% url 'flow_list' %}" class="back-link">
                    <i class="bi bi-arrow-left"></i> Back to Flows
                </a>
                <h1><i class="bi bi-magic me-2"></i>Create New Flow</h1>
                <p>Set up automated DM responses for your Instagram posts</p>
            </div>

            <form method="post" id="flowForm">
                {% csrf_token %}

                <!-- Basic Info Section -->
                <div class="section-card">
                    <div class="section-title">
                        <i class="bi bi-info-circle text-primary"></i>
                        Basic Information
                    </div>

                    <div class="mb-3">
                        <label for="title" class="form-label">Flow Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="title" name="title"
                               value="{{ flow.title|default:'' }}" maxlength="100" required
                               placeholder="e.g., Free Guide Giveaway">
                        <div class="form-text">Give your flow a name you'll remember</div>
                    </div>

                    <div class="mb-0">
                        <label for="description" class="form-label">Description <span class="text-muted fw-normal">(optional)</span></label>
                        <textarea class="form-control" id="description" name="description" rows="2"
                                  placeholder="What does this flow do?">{{ flow.description|default:'' }}</textarea>
                    </div>
                </div>

                <!-- Trigger Section -->
                <div class="section-card">
                    <div class="section-title">
                        <i class="bi bi-lightning-charge text-warning"></i>
                        Trigger Settings
                    </div>

                    <label class="form-label">When should this flow start?</label>

                    <div class="trigger-options">
                        <label class="trigger-option">
                            <input type="radio" name="trigger_type" value="comment_keyword"
                                   {% if flow.trigger_type != 'comment_any' %}checked{% endif %}>
                            <div class="trigger-option-card">
                                <div class="trigger-option-icon">
                                    <i class="bi bi-hash"></i>
                                </div>
                                <div class="trigger-option-content">
                                    <h6>Keyword Trigger</h6>
                                    <p>Respond when comment contains specific words</p>
                                </div>
                                <div class="trigger-option-check">
                                    <i class="bi bi-check2"></i>
                                </div>
                            </div>
                        </label>

                        <label class="trigger-option">
                            <input type="radio" name="trigger_type" value="comment_any"
                                   {% if flow.trigger_type == 'comment_any' %}checked{% endif %}>
                            <div class="trigger-option-card">
                                <div class="trigger-option-icon">
                                    <i class="bi bi-chat-dots"></i>
                                </div>
                                <div class="trigger-option-content">
                                    <h6>Any Comment</h6>
                                    <p>Respond to all comments on the post</p>
                                </div>
                                <div class="trigger-option-check">
                                    <i class="bi bi-check2"></i>
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- Keywords (shown only for keyword trigger) -->
                    <div id="keywords_section" class="mt-3">
                        <label class="form-label">Trigger Keywords</label>

                        <!-- Hidden input for form submission -->
                        <input type="hidden" id="keywords" name="keywords" value="{{ flow.keywords|default:'' }}">

                        <!-- Tag input container -->
                        <div class="keywords-container" id="keywordsContainer">
                            <div id="keywordTags"></div>
                            <input type="text" class="keyword-input" id="keywordInput"
                                   placeholder="Type keyword and press Enter">
                        </div>
                        <div class="form-text">Type a keyword and press <kbd>Enter</kbd> to add</div>

                        <!-- Quick add buttons -->
                        <div class="quick-add-section">
                            <span class="quick-add-label">Quick add:</span>
                            <div class="quick-add-buttons">
                                <button type="button" class="quick-add-btn" data-keyword="link">
                                    <i class="bi bi-plus"></i> link
                                </button>
                                <button type="button" class="quick-add-btn" data-keyword="free">
                                    <i class="bi bi-plus"></i> free
                                </button>
                                <button type="button" class="quick-add-btn" data-keyword="send">
                                    <i class="bi bi-plus"></i> send
                                </button>
                                <button type="button" class="quick-add-btn" data-keyword="info">
                                    <i class="bi bi-plus"></i> info
                                </button>
                                <button type="button" class="quick-add-btn" data-keyword="dm">
                                    <i class="bi bi-plus"></i> dm
                                </button>
                                <button type="button" class="quick-add-btn" data-keyword="yes">
                                    <i class="bi bi-plus"></i> yes
                                </button>
                                <button type="button" class="quick-add-btn" data-keyword="guide">
                                    <i class="bi bi-plus"></i> guide
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Post Selection Section -->
                <div class="section-card">
                    <div class="section-title">
                        <i class="bi bi-image text-info"></i>
                        Post Selection
                    </div>

                    <label class="form-label">Which post should trigger this flow?</label>

                    <input type="hidden" id="instagram_post_id" name="instagram_post_id"
                           value="{{ flow.instagram_post_id|default:'' }}">

                    <button type="button" class="post-select-btn" id="browsePostsBtn">
                        <i class="bi bi-grid-3x3-gap fs-4"></i>
                        <div>
                            <div class="fw-semibold">Select a Post</div>
                            <small>Or leave empty for all posts</small>
                        </div>
                    </button>

                    <div class="selected-post-preview" id="selectedPostPreview">
                        <img src="" alt="Selected post" id="selectedPostImg">
                        <div class="selected-post-info">
                            <div class="fw-semibold text-success"><i class="bi bi-check-circle me-1"></i>Post Selected</div>
                            <div class="post-id" id="selectedPostId"></div>
                        </div>
                        <button type="button" class="clear-post-btn" id="clearPostBtn">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>

                    <div class="form-text mt-2">
                        <span class="all-posts-badge" id="allPostsBadge">
                            <i class="bi bi-infinity"></i> Applies to all posts
                        </span>
                    </div>
                </div>

                <!-- Submit Actions -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-create">
                        <i class="bi bi-check-lg"></i>
                        Create Flow
                    </button>
                    <a href="{% url 'flow_list' %}" class="btn btn-cancel text-center">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- Post Selection Modal -->
<div class="modal fade" id="postSelectModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-grid-3x3-gap me-2"></i>Select Instagram Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="postsLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 mb-0 text-muted">Loading your posts...</p>
                </div>
                <div id="postsGrid" class="row g-2" style="display: none;"></div>
                <div id="postsError" class="alert alert-danger" style="display: none;"></div>
                <div id="postsEmpty" class="text-center py-4" style="display: none;">
                    <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                    <p class="mt-2 mb-0 text-muted">No posts found</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const triggerKeyword = document.querySelector('input[value="comment_keyword"]');
    const triggerAny = document.querySelector('input[value="comment_any"]');
    const keywordsSection = document.getElementById('keywords_section');
    const keywordsHiddenInput = document.getElementById('keywords');
    const keywordsContainer = document.getElementById('keywordsContainer');
    const keywordTagsContainer = document.getElementById('keywordTags');
    const keywordInput = document.getElementById('keywordInput');
    const postInput = document.getElementById('instagram_post_id');
    const browseBtn = document.getElementById('browsePostsBtn');
    const selectedPreview = document.getElementById('selectedPostPreview');
    const selectedPostImg = document.getElementById('selectedPostImg');
    const selectedPostId = document.getElementById('selectedPostId');
    const clearPostBtn = document.getElementById('clearPostBtn');
    const allPostsBadge = document.getElementById('allPostsBadge');
    const modal = new bootstrap.Modal(document.getElementById('postSelectModal'));

    let postsCache = null;
    let keywords = [];

    // Initialize keywords from hidden input
    function initKeywords() {
        const initialValue = keywordsHiddenInput.value.trim();
        if (initialValue) {
            keywords = initialValue.split(',').map(k => k.trim().toLowerCase()).filter(k => k);
        }
        renderKeywords();
    }

    // Render keyword tags
    function renderKeywords() {
        keywordTagsContainer.innerHTML = '';
        keywords.forEach((keyword, index) => {
            const tag = document.createElement('span');
            tag.className = 'keyword-tag';
            tag.innerHTML = `
                ${keyword}
                <button type="button" class="remove-tag" data-index="${index}">
                    <i class="bi bi-x"></i>
                </button>
            `;
            keywordTagsContainer.appendChild(tag);
        });

        // Update hidden input
        keywordsHiddenInput.value = keywords.join(', ');

        // Update quick add buttons state
        updateQuickAddButtons();
    }

    // Add a keyword
    function addKeyword(keyword) {
        keyword = keyword.trim().toLowerCase();
        if (keyword && !keywords.includes(keyword)) {
            keywords.push(keyword);
            renderKeywords();
            return true;
        }
        return false;
    }

    // Remove a keyword
    function removeKeyword(index) {
        keywords.splice(index, 1);
        renderKeywords();
    }

    // Update quick add buttons to show which are already added
    function updateQuickAddButtons() {
        document.querySelectorAll('.quick-add-btn').forEach(btn => {
            const keyword = btn.dataset.keyword;
            if (keywords.includes(keyword)) {
                btn.classList.add('added');
                btn.innerHTML = `<i class="bi bi-check"></i> ${keyword}`;
            } else {
                btn.classList.remove('added');
                btn.innerHTML = `<i class="bi bi-plus"></i> ${keyword}`;
            }
        });
    }

    // Handle input keypress
    keywordInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const value = this.value.trim();
            if (value) {
                // Handle comma-separated input
                value.split(',').forEach(k => addKeyword(k));
                this.value = '';
            }
        } else if (e.key === 'Backspace' && !this.value && keywords.length > 0) {
            // Remove last keyword on backspace when input is empty
            removeKeyword(keywords.length - 1);
        }
    });

    // Focus input when clicking container
    keywordsContainer.addEventListener('click', function(e) {
        if (e.target === this || e.target === keywordTagsContainer) {
            keywordInput.focus();
        }
    });

    // Handle remove tag clicks
    keywordTagsContainer.addEventListener('click', function(e) {
        const removeBtn = e.target.closest('.remove-tag');
        if (removeBtn) {
            const index = parseInt(removeBtn.dataset.index);
            removeKeyword(index);
        }
    });

    // Quick add buttons
    document.querySelectorAll('.quick-add-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const keyword = this.dataset.keyword;
            if (keywords.includes(keyword)) {
                // Remove if already added
                const index = keywords.indexOf(keyword);
                removeKeyword(index);
            } else {
                // Add if not present
                addKeyword(keyword);
            }
        });
    });

    // Initialize keywords on page load
    initKeywords();

    // Toggle keywords section
    function toggleKeywords() {
        keywordsSection.style.display = triggerKeyword.checked ? 'block' : 'none';
    }

    document.querySelectorAll('input[name="trigger_type"]').forEach(radio => {
        radio.addEventListener('change', toggleKeywords);
    });
    toggleKeywords();

    // Update post selection UI
    function updatePostUI() {
        const hasPost = postInput.value.trim() !== '';

        if (hasPost) {
            browseBtn.classList.add('has-post');
            browseBtn.innerHTML = `
                <i class="bi bi-check-circle fs-4"></i>
                <div>
                    <div class="fw-semibold">Post Selected</div>
                    <small>Click to change</small>
                </div>
            `;
            selectedPreview.classList.add('visible');
            selectedPostId.textContent = postInput.value;
            allPostsBadge.style.display = 'none';

            // Try to show thumbnail if we have posts cached
            if (postsCache) {
                const post = postsCache.find(p => p.id === postInput.value);
                if (post) {
                    const imgUrl = post.media_type === 'VIDEO'
                        ? (post.thumbnail_url || '/static/img/placeholder.png')
                        : (post.media_url || post.thumbnail_url || '/static/img/placeholder.png');
                    selectedPostImg.src = imgUrl;
                }
            }
        } else {
            browseBtn.classList.remove('has-post');
            browseBtn.innerHTML = `
                <i class="bi bi-grid-3x3-gap fs-4"></i>
                <div>
                    <div class="fw-semibold">Select a Post</div>
                    <small>Or leave empty for all posts</small>
                </div>
            `;
            selectedPreview.classList.remove('visible');
            allPostsBadge.style.display = 'inline-flex';
        }
    }

    // Initialize UI
    updatePostUI();

    // Clear post selection
    clearPostBtn.addEventListener('click', function() {
        postInput.value = '';
        updatePostUI();
    });

    // Browse posts
    browseBtn.addEventListener('click', function() {
        modal.show();
        loadPosts();
    });

    function loadPosts() {
        const loading = document.getElementById('postsLoading');
        const grid = document.getElementById('postsGrid');
        const error = document.getElementById('postsError');
        const empty = document.getElementById('postsEmpty');

        loading.style.display = 'block';
        grid.style.display = 'none';
        error.style.display = 'none';
        empty.style.display = 'none';

        fetch('{% url "instagram_api_posts" %}')
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                if (data.success) {
                    postsCache = data.posts;

                    if (data.posts.length === 0) {
                        empty.style.display = 'block';
                        return;
                    }

                    grid.innerHTML = '';
                    data.posts.forEach(post => {
                        const col = document.createElement('div');
                        col.className = 'col-4 col-md-3';
                        const imgUrl = post.media_type === 'VIDEO'
                            ? (post.thumbnail_url || '/static/img/placeholder.png')
                            : (post.media_url || post.thumbnail_url || '/static/img/placeholder.png');
                        const isVideo = post.media_type === 'VIDEO';
                        const isSelected = postInput.value === post.id;

                        col.innerHTML = `
                            <div class="post-item p-1 position-relative ${isSelected ? 'border-primary' : ''}"
                                 data-post-id="${post.id}"
                                 data-img-url="${imgUrl}">
                                <img src="${imgUrl}" class="img-fluid rounded"
                                     style="aspect-ratio: 1; object-fit: cover; width: 100%;">
                                ${isVideo ? '<span class="position-absolute top-50 start-50 translate-middle text-white" style="text-shadow: 0 1px 3px rgba(0,0,0,0.5);"><i class="bi bi-play-circle-fill fs-3"></i></span>' : ''}
                                ${isSelected ? '<span class="position-absolute top-0 end-0 m-2 badge bg-primary"><i class="bi bi-check"></i></span>' : ''}
                            </div>
                        `;

                        col.querySelector('.post-item').addEventListener('click', function() {
                            postInput.value = post.id;
                            selectedPostImg.src = imgUrl;
                            updatePostUI();
                            modal.hide();
                        });

                        grid.appendChild(col);
                    });
                    grid.style.display = 'flex';
                    grid.classList.add('flex-wrap');

                    // Update the preview image if we have a post selected
                    updatePostUI();
                } else {
                    error.textContent = data.error || 'Failed to load posts';
                    error.style.display = 'block';
                }
            })
            .catch(err => {
                loading.style.display = 'none';
                error.textContent = 'Error loading posts. Please try again.';
                error.style.display = 'block';
            });
    }
});
</script>
{% endblock %}
