{% extends 'base.html' %}

{% block title %}Create Bulk Videos - {{ quiz.title }}{% endblock %}

{% block content %}
<section class="py-4 py-md-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb small">
                        <li class="breadcrumb-item"><a href="{% url 'quiz_home' %}">Quizzes</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'quiz_detail' quiz.slug %}">{{ quiz.title }}</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'video_export_choice' quiz.slug %}">Export Video</a></li>
                        <li class="breadcrumb-item active">Bulk Videos</li>
                    </ol>
                </nav>

                <div class="card p-4">
                    <div class="text-center mb-4">
                        <i class="bi bi-collection-play text-success" style="font-size: 3rem;"></i>
                        <h3 class="fw-bold mt-3">Create Bulk Videos</h3>
                        <p class="text-muted">Each selected question will become a separate video job</p>
                    </div>

                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>How it works:</strong> Select questions, configure options, and submit. Each question creates its own video.
                    </div>

                    <form method="post" id="bulkForm">
                        {% csrf_token %}

                        <!-- Social Media Posting (Moved to top) -->
                        <div class="card mb-4" id="socialSection">
                            <div class="card-body">
                                <h5 class="fw-bold mb-3"><i class="bi bi-share me-2"></i>Auto-Post to Social Media</h5>
                                <p class="text-muted small">Enable to show social media fields for each question</p>

                                <div class="row">
                                    <div class="col-md-6">
                                        {% if instagram_connected %}
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="postToInstagram" name="post_to_instagram">
                                            <label class="form-check-label" for="postToInstagram">
                                                <i class="bi bi-instagram text-danger me-2"></i><strong>Post to Instagram Reels</strong>
                                            </label>
                                        </div>
                                        {% else %}
                                        <div class="text-muted small">
                                            <i class="bi bi-instagram me-2"></i>Instagram not connected. <a href="{% url 'instagram_connect' %}">Connect</a>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        {% if youtube_connected %}
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="postToYouTube" name="post_to_youtube">
                                            <label class="form-check-label" for="postToYouTube">
                                                <i class="bi bi-youtube text-danger me-2"></i><strong>Post to YouTube Shorts</strong>
                                            </label>
                                        </div>
                                        {% else %}
                                        <div class="text-muted small">
                                            <i class="bi bi-youtube me-2"></i>YouTube not connected. <a href="{% url 'youtube_connect' %}">Connect</a>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Global Options -->
                        <div class="card mb-4" id="globalOptions">
                            <div class="card-body">
                                <h5 class="fw-bold mb-3"><i class="bi bi-gear me-2"></i>Global Options</h5>

                                {% if templates %}
                                <div class="mb-0">
                                    <label class="form-label"><strong>Video Template</strong></label>
                                    <input type="hidden" name="template_id" id="templateId" value="{{ default_template_id }}">
                                    <div class="row g-2">
                                        {% for template in templates %}
                                        <div class="col-4 col-md-2">
                                            <div class="template-card {% if template.is_default %}selected{% endif %} {% if not template.can_use %}locked{% endif %}"
                                                 data-template-id="{{ template.id }}" data-can-use="{{ template.can_use|yesno:'true,false' }}">
                                                <div class="template-preview template-{{ template.slug }}">
                                                    {% if not template.can_use %}<div class="template-lock"><i class="bi bi-lock-fill"></i></div>{% endif %}
                                                </div>
                                                <div class="template-name">{{ template.name }}</div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Question Selection -->
                        <div class="mb-4" id="questionSection">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="fw-bold mb-0"><i class="bi bi-list-check me-2"></i>Select Questions</h5>
                                <div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllBtn">Select All</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllBtn">Deselect All</button>
                                </div>
                            </div>

                            <div class="list-group" id="questionList">
                                {% for question in questions %}
                                <div class="list-group-item">
                                    <label class="d-flex align-items-start w-100" style="cursor: pointer;">
                                        <input type="checkbox" name="questions" value="{{ question.id }}" class="form-check-input me-3 mt-1 question-checkbox">
                                        <div class="flex-grow-1">
                                            <span class="badge bg-light text-dark me-2">Q{{ forloop.counter }}</span>
                                            <span>{{ question.text|truncatewords:25 }}</span>
                                            <br>
                                            <small class="text-muted">{{ question.options.count }} options</small>
                                        </div>
                                    </label>

                                    <!-- Per-question options (shown when selected) -->
                                    <div class="question-options d-none mt-3" data-question-id="{{ question.id }}">
                                        <!-- Video Options -->
                                        <div class="row g-2 mb-2">
                                            <div class="col-md-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" name="show_answer_{{ question.id }}" checked>
                                                    <label class="form-check-label small">Show Answer</label>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <input type="text" class="form-control form-control-sm" name="quiz_heading_{{ question.id }}" placeholder="Quiz heading" maxlength="40">
                                            </div>
                                            <div class="col-md-3">
                                                <input type="text" class="form-control form-control-sm" name="intro_text_{{ question.id }}" placeholder="Intro text" maxlength="100">
                                            </div>
                                            <div class="col-md-3">
                                                <input type="text" class="form-control form-control-sm" name="outro_text_{{ question.id }}" placeholder="Outro text" maxlength="100">
                                            </div>
                                        </div>

                                        <!-- Instagram fields (shown when Instagram toggle is on) -->
                                        <div class="instagram-fields d-none mt-2">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text bg-danger text-white"><i class="bi bi-instagram"></i></span>
                                                <input type="text" class="form-control" name="caption_{{ question.id }}" placeholder="Instagram caption with hashtags..." maxlength="2200">
                                            </div>
                                        </div>

                                        <!-- YouTube fields (shown when YouTube toggle is on) -->
                                        <div class="youtube-fields d-none mt-2">
                                            <div class="row g-2">
                                                <div class="col-md-4">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text bg-danger text-white"><i class="bi bi-youtube"></i></span>
                                                        <input type="text" class="form-control" name="yt_title_{{ question.id }}" placeholder="YouTube title" maxlength="100">
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <input type="text" class="form-control form-control-sm" name="yt_desc_{{ question.id }}" placeholder="YouTube description" maxlength="500">
                                                </div>
                                                <div class="col-md-4">
                                                    <input type="text" class="form-control form-control-sm" name="yt_tags_{{ question.id }}" placeholder="Tags (comma separated)" maxlength="500">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <div class="mt-3">
                                <small class="text-muted">Selected: <strong id="selectedCount">0</strong> questions = <strong id="jobCount">0</strong> videos</small>
                            </div>
                        </div>

                        <!-- Progress Section (hidden) -->
                        <div class="d-none" id="progressSection">
                            <div class="text-center py-4">
                                <div class="spinner-border text-success mb-3" role="status"></div>
                                <h5 class="fw-bold">Submitting <span id="submitProgress">0</span> Jobs...</h5>
                                <p class="text-muted">Please wait while we submit your video jobs.</p>
                            </div>
                        </div>

                        <!-- Success Section (hidden) -->
                        <div class="d-none" id="successSection">
                            <div class="alert alert-success text-center">
                                <i class="bi bi-check-circle-fill" style="font-size: 3rem;"></i>
                                <h5 class="fw-bold mt-3">Jobs Submitted!</h5>
                                <p><span id="totalJobsCreated">0</span> video jobs are now processing in the background.</p>
                                <p class="text-muted">You can safely close this page. Videos will be generated and posted automatically.</p>
                                <a href="{% url 'video_export_choice' quiz.slug %}" class="btn btn-success">View Jobs</a>
                                <a href="{% url 'video_job_list' %}" class="btn btn-outline-primary">All My Jobs</a>
                            </div>
                        </div>

                        <!-- Error Section (hidden) -->
                        <div class="alert alert-danger d-none" id="errorSection">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <span id="errorMessage"></span>
                        </div>

                        <!-- Buttons -->
                        <div class="d-grid gap-2" id="buttonSection">
                            <button type="submit" class="btn btn-success btn-lg" id="submitBtn" disabled>
                                <i class="bi bi-lightning-charge me-2"></i>Submit <span id="btnJobCount">0</span> Video Jobs
                            </button>
                            <a href="{% url 'video_export_choice' quiz.slug %}" class="btn btn-outline-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('bulkForm');
    const submitBtn = document.getElementById('submitBtn');
    const checkboxes = document.querySelectorAll('.question-checkbox');
    const selectedCountEl = document.getElementById('selectedCount');
    const jobCountEl = document.getElementById('jobCount');
    const btnJobCountEl = document.getElementById('btnJobCount');

    const instagramToggle = document.getElementById('postToInstagram');
    const youtubeToggle = document.getElementById('postToYouTube');

    // Update selection and show/hide options
    function updateSelection() {
        const checked = document.querySelectorAll('.question-checkbox:checked').length;
        selectedCountEl.textContent = checked;
        jobCountEl.textContent = checked;
        btnJobCountEl.textContent = checked;
        submitBtn.disabled = checked < 1;

        // Show/hide per-question options based on selection
        checkboxes.forEach(function(cb) {
            const optionsDiv = cb.closest('.list-group-item').querySelector('.question-options');
            if (cb.checked) {
                optionsDiv.classList.remove('d-none');
            } else {
                optionsDiv.classList.add('d-none');
            }
        });

        // Update social media fields visibility
        updateSocialFields();
    }

    // Update social media fields visibility
    function updateSocialFields() {
        const instagramOn = instagramToggle && instagramToggle.checked;
        const youtubeOn = youtubeToggle && youtubeToggle.checked;

        document.querySelectorAll('.instagram-fields').forEach(function(el) {
            const questionItem = el.closest('.list-group-item');
            const checkbox = questionItem.querySelector('.question-checkbox');
            if (instagramOn && checkbox.checked) {
                el.classList.remove('d-none');
            } else {
                el.classList.add('d-none');
            }
        });

        document.querySelectorAll('.youtube-fields').forEach(function(el) {
            const questionItem = el.closest('.list-group-item');
            const checkbox = questionItem.querySelector('.question-checkbox');
            if (youtubeOn && checkbox.checked) {
                el.classList.remove('d-none');
            } else {
                el.classList.add('d-none');
            }
        });
    }

    checkboxes.forEach(function(cb) {
        cb.addEventListener('change', updateSelection);
    });

    // Social media toggle listeners
    if (instagramToggle) {
        instagramToggle.addEventListener('change', updateSocialFields);
    }
    if (youtubeToggle) {
        youtubeToggle.addEventListener('change', updateSocialFields);
    }

    // Select/Deselect all
    document.getElementById('selectAllBtn').addEventListener('click', function() {
        checkboxes.forEach(cb => cb.checked = true);
        updateSelection();
    });

    document.getElementById('deselectAllBtn').addEventListener('click', function() {
        checkboxes.forEach(cb => cb.checked = false);
        updateSelection();
    });

    // Template selection
    const templateCards = document.querySelectorAll('.template-card');
    const templateIdInput = document.getElementById('templateId');

    templateCards.forEach(function(card) {
        card.addEventListener('click', function() {
            if (this.dataset.canUse !== 'true') {
                alert('Upgrade to Pro to use this template.');
                return;
            }
            templateCards.forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            if (templateIdInput) templateIdInput.value = this.dataset.templateId;
        });
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const checkedCount = document.querySelectorAll('.question-checkbox:checked').length;
        document.getElementById('submitProgress').textContent = checkedCount;

        document.getElementById('questionSection').classList.add('d-none');
        document.getElementById('globalOptions').classList.add('d-none');
        document.getElementById('socialSection').classList.add('d-none');
        document.getElementById('buttonSection').classList.add('d-none');
        document.getElementById('progressSection').classList.remove('d-none');

        fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('progressSection').classList.add('d-none');

            if (data.error) {
                document.getElementById('errorMessage').textContent = data.error;
                document.getElementById('errorSection').classList.remove('d-none');
                document.getElementById('questionSection').classList.remove('d-none');
                document.getElementById('globalOptions').classList.remove('d-none');
                document.getElementById('socialSection').classList.remove('d-none');
                document.getElementById('buttonSection').classList.remove('d-none');
            } else {
                document.getElementById('totalJobsCreated').textContent = data.total_jobs;
                document.getElementById('successSection').classList.remove('d-none');
            }
        })
        .catch(error => {
            document.getElementById('progressSection').classList.add('d-none');
            document.getElementById('errorMessage').textContent = 'Failed: ' + error.message;
            document.getElementById('errorSection').classList.remove('d-none');
            document.getElementById('questionSection').classList.remove('d-none');
            document.getElementById('globalOptions').classList.remove('d-none');
            document.getElementById('socialSection').classList.remove('d-none');
            document.getElementById('buttonSection').classList.remove('d-none');
        });
    });
});
</script>

<style>
.template-card { border: 2px solid #dee2e6; border-radius: 6px; padding: 4px; cursor: pointer; }
.template-card:hover { border-color: #6c757d; }
.template-card.selected { border-color: #198754; box-shadow: 0 0 0 2px rgba(25, 135, 84, 0.25); }
.template-card.locked { opacity: 0.7; cursor: not-allowed; }
.template-preview { height: 40px; border-radius: 4px; position: relative; }
.template-lock { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.6); color: #fff; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; }
.template-name { text-align: center; font-size: 10px; margin-top: 2px; }
.template-dark-purple { background: linear-gradient(135deg, #121212, #8a2be2); }
.template-clean-light { background: linear-gradient(135deg, #fafafa, #3b82f6); }
.template-neon-glow { background: linear-gradient(135deg, #0a0a14, #00ffff); }
.template-sunset { background: linear-gradient(135deg, #1e141e, #ff6432); }
.template-ocean-blue { background: linear-gradient(135deg, #0a192f, #00c8c8); }
.question-options { background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 3px solid #198754; }
</style>
{% endblock %}
