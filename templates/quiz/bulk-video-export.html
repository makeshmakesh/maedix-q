{% extends 'base.html' %}

{% block title %}Bulk Video Export - {{ quiz.title }}{% endblock %}

{% block content %}
<section class="py-4 py-md-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb small">
                        <li class="breadcrumb-item"><a href="{% url 'quiz_home' %}">Quizzes</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'quiz_detail' quiz.slug %}">{{ quiz.title }}</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'quiz_video_export' quiz.slug %}">Export Video</a></li>
                        <li class="breadcrumb-item active">Bulk Export</li>
                    </ol>
                </nav>

                <div class="card p-4">
                    <div class="text-center mb-4">
                        <i class="bi bi-collection-play text-primary" style="font-size: 3rem;"></i>
                        <h3 class="fw-bold mt-3">Auto Generate & Post Multiple</h3>
                        <p class="text-muted">Configure each question individually, then generate and post automatically</p>
                    </div>

                    <!-- Active Jobs Warning -->
                    {% if active_jobs %}
                    <div class="alert alert-warning mb-4">
                        <h6 class="fw-bold mb-2"><i class="bi bi-hourglass-split me-2"></i>Job In Progress</h6>
                        <p class="mb-0">You have {{ active_jobs.count }} bulk job(s) currently processing. Please wait for them to complete before starting a new one.</p>
                    </div>
                    {% endif %}

                    <form method="post" id="bulkExportForm">
                        {% csrf_token %}

                        <!-- Platform Selection -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="fw-bold mb-0"><i class="bi bi-share me-2"></i>Post To</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-2">
                                            {% if instagram_connected %}
                                            <input class="form-check-input" type="checkbox" id="postToInstagram" name="post_to_instagram">
                                            <label class="form-check-label" for="postToInstagram">
                                                <i class="bi bi-instagram text-danger me-1"></i> Instagram Reels
                                            </label>
                                            {% else %}
                                            <input class="form-check-input" type="checkbox" disabled>
                                            <label class="form-check-label text-muted">
                                                <i class="bi bi-instagram me-1"></i> Instagram (not connected)
                                                <a href="{% url 'instagram_connect' %}" class="ms-2 small">Connect</a>
                                            </label>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch mb-2">
                                            {% if youtube_connected %}
                                            <input class="form-check-input" type="checkbox" id="postToYouTube" name="post_to_youtube">
                                            <label class="form-check-label" for="postToYouTube">
                                                <i class="bi bi-youtube text-danger me-1"></i> YouTube Shorts
                                            </label>
                                            {% else %}
                                            <input class="form-check-input" type="checkbox" disabled>
                                            <label class="form-check-label text-muted">
                                                <i class="bi bi-youtube me-1"></i> YouTube (not connected)
                                                <a href="{% url 'youtube_connect' %}" class="ms-2 small">Connect</a>
                                            </label>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Questions Configuration -->
                        <div class="mb-4" id="questionsSection">
                            <h5 class="fw-bold mb-3">Configure Questions</h5>
                            <p class="text-muted small">Check the questions you want to include and configure each one individually.</p>

                            {% for question in questions %}
                            <div class="card mb-3 question-card" data-question-id="{{ question.id }}">
                                <div class="card-header d-flex align-items-center">
                                    <div class="form-check">
                                        <input class="form-check-input question-checkbox" type="checkbox"
                                               name="question_ids" value="{{ question.id }}" id="q_{{ question.id }}">
                                        <label class="form-check-label fw-bold" for="q_{{ question.id }}">
                                            Q{{ forloop.counter }}: {{ question.text|truncatewords:15 }}
                                        </label>
                                    </div>
                                </div>
                                <div class="card-body question-config d-none">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox"
                                                       name="reveal_answer_{{ question.id }}"
                                                       id="reveal_{{ question.id }}" checked>
                                                <label class="form-check-label small" for="reveal_{{ question.id }}">
                                                    Reveal Answer
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="text" class="form-control form-control-sm"
                                                   name="intro_text_{{ question.id }}"
                                                   placeholder="Intro text (optional)" maxlength="100">
                                        </div>
                                        <div class="col-md-4">
                                            <input type="text" class="form-control form-control-sm"
                                                   name="outro_text_{{ question.id }}"
                                                   placeholder="Outro text (optional)" maxlength="100">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Summary -->
                        <div class="alert alert-info mb-4" id="selectionSummary">
                            <strong>Selected:</strong> <span id="selectedCount">0</span> questions
                            <span class="float-end">Est. time: <span id="estTime">0</span> min</span>
                        </div>

                        <!-- Progress Section (hidden by default) -->
                        <div class="mb-4 d-none" id="progressSection">
                            <h5 class="fw-bold mb-3 text-center">Processing...</h5>
                            <div class="alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <strong>Please wait!</strong> Do not refresh or close this page while videos are being generated and posted.
                            </div>
                            <div class="progress mb-3" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                     role="progressbar" id="progressBar" style="width: 0%;">
                                    0%
                                </div>
                            </div>
                            <p class="text-center" id="progressMessage">Initializing...</p>

                            <!-- Results Table -->
                            <div class="table-responsive mt-4" id="resultsTable">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Question</th>
                                            <th>Video</th>
                                            <th>Instagram</th>
                                            <th>YouTube</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resultsBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Completed Section (hidden by default) -->
                        <div class="mb-4 d-none" id="completedSection">
                            <div class="text-center">
                                <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                                <h5 class="fw-bold mt-3" id="completedTitle">Processing Complete!</h5>
                                <p class="text-muted" id="completedMessage">All videos have been generated and posted.</p>
                            </div>
                        </div>

                        <div class="d-grid gap-2" id="buttonSection">
                            <button type="submit" class="btn btn-primary btn-lg" id="startBtn" disabled>
                                <i class="bi bi-play-fill me-2"></i>Start Bulk Generation
                            </button>
                            <a href="{% url 'quiz_video_export' quiz.slug %}" class="btn btn-outline-secondary">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('bulkExportForm');
    const startBtn = document.getElementById('startBtn');
    const progressSection = document.getElementById('progressSection');
    const progressBar = document.getElementById('progressBar');
    const progressMessage = document.getElementById('progressMessage');
    const buttonSection = document.getElementById('buttonSection');
    const resultsBody = document.getElementById('resultsBody');
    const selectedCountEl = document.getElementById('selectedCount');
    const estTimeEl = document.getElementById('estTime');
    const questionsSection = document.getElementById('questionsSection');
    const selectionSummary = document.getElementById('selectionSummary');
    const completedSection = document.getElementById('completedSection');
    const completedTitle = document.getElementById('completedTitle');
    const completedMessage = document.getElementById('completedMessage');

    const checkboxes = document.querySelectorAll('.question-checkbox');

    // Store question labels for results table
    const questionLabels = {};
    checkboxes.forEach(function(cb, index) {
        const label = cb.closest('.card-header').querySelector('label').textContent.trim();
        questionLabels[cb.value] = label;
    });

    // Toggle question config visibility
    checkboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const card = this.closest('.question-card');
            const config = card.querySelector('.question-config');
            if (this.checked) {
                config.classList.remove('d-none');
            } else {
                config.classList.add('d-none');
            }
            updateSummary();
        });
    });

    function updateSummary() {
        const selected = document.querySelectorAll('.question-checkbox:checked').length;
        selectedCountEl.textContent = selected;
        // Estimate: ~2 min per video generation + posting
        estTimeEl.textContent = selected * 2;
        startBtn.disabled = selected === 0;
    }

    // Track if processing
    let isProcessing = false;

    // Warn user before leaving during processing
    window.addEventListener('beforeunload', function(e) {
        if (isProcessing) {
            e.preventDefault();
            e.returnValue = 'Videos are still being generated. Are you sure you want to leave?';
            return e.returnValue;
        }
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(form);

        // Mark as processing
        isProcessing = true;

        // Hide form, show progress
        buttonSection.classList.add('d-none');
        questionsSection.classList.add('d-none');
        selectionSummary.classList.add('d-none');
        progressSection.classList.remove('d-none');

        // Initialize results table
        resultsBody.innerHTML = '';
        document.querySelectorAll('.question-checkbox:checked').forEach(function(cb) {
            const qid = cb.value;
            const label = questionLabels[qid] || 'Question ' + qid;
            resultsBody.innerHTML += `
                <tr id="result_${qid}">
                    <td>${label}</td>
                    <td><span class="badge bg-secondary">Pending</span></td>
                    <td><span class="badge bg-secondary">-</span></td>
                    <td><span class="badge bg-secondary">-</span></td>
                    <td><span class="text-muted">Waiting...</span></td>
                </tr>
            `;
        });

        // Submit
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                location.reload();
                return;
            }
            pollProgress(data.job_id);
        })
        .catch(error => {
            alert('Failed to start: ' + error.message);
            location.reload();
        });
    });

    function pollProgress(jobId) {
        const interval = setInterval(function() {
            fetch(`{% url 'bulk_video_progress' job_id=0 %}`.replace('0', jobId))
            .then(response => response.json())
            .then(data => {
                progressBar.style.width = data.progress_percent + '%';
                progressBar.textContent = data.progress_percent + '%';

                // Update current status
                if (data.current_question_id) {
                    const stepName = {
                        'generating': 'Generating video',
                        'posting_instagram': 'Posting to Instagram',
                        'posting_youtube': 'Posting to YouTube'
                    }[data.current_step] || data.current_step;
                    progressMessage.textContent = `Processing Q${data.current_question_id}: ${stepName}...`;
                }

                // Update results table
                if (data.results) {
                    data.results.forEach(function(result) {
                        const row = document.getElementById('result_' + result.question_id);
                        if (row) {
                            const videoBadge = result.video_url ?
                                '<span class="badge bg-success">Done</span>' :
                                '<span class="badge bg-danger">Failed</span>';

                            let igBadge = '<span class="badge bg-secondary">-</span>';
                            if (result.instagram_posted) {
                                igBadge = '<span class="badge bg-success">Posted</span>';
                            } else if (result.error && result.error.includes('Instagram')) {
                                igBadge = '<span class="badge bg-danger">Failed</span>';
                            }

                            let ytBadge = '<span class="badge bg-secondary">-</span>';
                            if (result.youtube_posted) {
                                ytBadge = '<span class="badge bg-success">Posted</span>';
                            } else if (result.error && result.error.includes('YouTube')) {
                                ytBadge = '<span class="badge bg-danger">Failed</span>';
                            }

                            const statusCell = result.error ?
                                `<span class="text-danger small">${result.error}</span>` :
                                '<span class="text-success">OK</span>';

                            row.innerHTML = `
                                <td>${questionLabels[result.question_id] || 'Q' + result.question_id}</td>
                                <td>${videoBadge}</td>
                                <td>${igBadge}</td>
                                <td>${ytBadge}</td>
                                <td>${statusCell}</td>
                            `;
                        }
                    });
                }

                // Check if complete
                if (data.status === 'completed' || data.status === 'failed' || data.status === 'partially_completed') {
                    clearInterval(interval);
                    isProcessing = false;

                    progressBar.classList.remove('progress-bar-animated');

                    if (data.status === 'completed') {
                        progressMessage.textContent = 'All done!';
                        completedTitle.textContent = 'All Videos Processed!';
                        completedMessage.textContent = 'All videos have been generated and posted successfully.';
                    } else if (data.status === 'failed') {
                        progressMessage.textContent = 'Job failed';
                        completedTitle.textContent = 'Processing Failed';
                        completedMessage.textContent = data.error_message || 'An error occurred during processing.';
                        completedSection.querySelector('i').classList.remove('text-success');
                        completedSection.querySelector('i').classList.add('text-danger');
                        completedSection.querySelector('i').classList.remove('bi-check-circle-fill');
                        completedSection.querySelector('i').classList.add('bi-x-circle-fill');
                    } else {
                        progressMessage.textContent = 'Completed with some errors';
                        completedTitle.textContent = 'Partially Completed';
                        completedMessage.textContent = 'Some videos were processed successfully, but there were errors with others.';
                        completedSection.querySelector('i').classList.remove('text-success');
                        completedSection.querySelector('i').classList.add('text-warning');
                        completedSection.querySelector('i').classList.remove('bi-check-circle-fill');
                        completedSection.querySelector('i').classList.add('bi-exclamation-circle-fill');
                    }

                    completedSection.classList.remove('d-none');

                    // Show back button
                    buttonSection.innerHTML = `
                        <a href="{% url 'quiz_video_export' quiz.slug %}" class="btn btn-primary btn-lg">
                            <i class="bi bi-arrow-left me-2"></i>Back to Export
                        </a>
                    `;
                    buttonSection.classList.remove('d-none');
                }
            })
            .catch(error => {
                console.error('Error polling progress:', error);
            });
        }, 2000);
    }
});
</script>
{% endblock %}
