{% extends 'base.html' %}

{% block title %}Leaderboard{% endblock %}

{% block content %}
<section class="py-4 py-md-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="text-center mb-4">
                    <h2 class="fw-bold"><i class="bi bi-trophy-fill text-warning"></i> Leaderboard</h2>
                    <p class="text-muted">Top performers on Maedix-Q</p>
                </div>

                <!-- Sort Options -->
                <div class="d-flex justify-content-center flex-wrap gap-2 mb-4">
                    <a href="?sort=xp" class="btn btn-sm {% if sort_by == 'xp' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        <i class="bi bi-trophy"></i> XP Points
                    </a>
                    <a href="?sort=quizzes" class="btn btn-sm {% if sort_by == 'quizzes' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        <i class="bi bi-check-circle"></i> Quizzes Passed
                    </a>
                    <a href="?sort=streak" class="btn btn-sm {% if sort_by == 'streak' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                        <i class="bi bi-fire"></i> Longest Streak
                    </a>
                </div>

                <!-- User's Rank Card (if logged in) -->
                {% if user_rank and user_stats %}
                <div class="card p-3 mb-4 border-primary">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div class="me-3 text-center" style="min-width: 50px;">
                                <span class="badge bg-primary fs-6">#{{ user_rank }}</span>
                            </div>
                            <div>
                                <h6 class="mb-0 fw-bold">{{ user.get_full_name|default:user.username }}</h6>
                                <small class="text-muted">Your Position</small>
                            </div>
                        </div>
                        <div class="text-end">
                            {% if sort_by == 'quizzes' %}
                            <h5 class="mb-0 text-success fw-bold">{{ user_stats.total_quizzes_passed }}</h5>
                            <small class="text-muted">Quizzes</small>
                            {% elif sort_by == 'streak' %}
                            <h5 class="mb-0 text-danger fw-bold">{{ user_stats.longest_streak }}</h5>
                            <small class="text-muted">Days</small>
                            {% else %}
                            <h5 class="mb-0 text-warning fw-bold">{{ user_stats.xp_points }}</h5>
                            <small class="text-muted">XP</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if leaderboard %}
                <!-- Mobile Cards View -->
                <div class="d-md-none">
                    {% for stats in leaderboard %}
                    <div class="card mb-2 p-3 {% if user.is_authenticated and stats.user == user %}border-primary{% endif %}">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                {% if forloop.counter == 1 %}
                                <span class="badge bg-warning text-dark fs-6"><i class="bi bi-trophy-fill"></i> 1</span>
                                {% elif forloop.counter == 2 %}
                                <span class="badge bg-secondary fs-6"><i class="bi bi-trophy-fill"></i> 2</span>
                                {% elif forloop.counter == 3 %}
                                <span class="badge fs-6" style="background: #cd7f32;"><i class="bi bi-trophy-fill"></i> 3</span>
                                {% else %}
                                <span class="text-muted fw-bold">#{{ forloop.counter }}</span>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-0">
                                    {{ stats.user.get_full_name|default:stats.user.username }}
                                    {% if user.is_authenticated and stats.user == user %}
                                    <span class="badge bg-primary ms-1">You</span>
                                    {% endif %}
                                </h6>
                                <small class="text-muted">{{ stats.total_quizzes_passed }}/{{ stats.total_quizzes_taken }} quizzes</small>
                            </div>
                            <div class="text-end">
                                {% if sort_by == 'quizzes' %}
                                <span class="text-success fw-bold">{{ stats.total_quizzes_passed }}</span>
                                {% elif sort_by == 'streak' %}
                                <span class="text-danger fw-bold"><i class="bi bi-fire"></i> {{ stats.longest_streak }}</span>
                                {% else %}
                                <span class="text-warning fw-bold">{{ stats.xp_points }} XP</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Desktop Table View -->
                <div class="card d-none d-md-block">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 80px;">Rank</th>
                                    <th>User</th>
                                    <th class="text-center">Quizzes</th>
                                    <th class="text-center">Accuracy</th>
                                    <th class="text-center">Streak</th>
                                    <th class="text-end">XP</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stats in leaderboard %}
                                <tr {% if user.is_authenticated and stats.user == user %}class="table-primary"{% endif %}>
                                    <td>
                                        {% if forloop.counter == 1 %}
                                        <span class="badge bg-warning text-dark"><i class="bi bi-trophy-fill"></i> 1</span>
                                        {% elif forloop.counter == 2 %}
                                        <span class="badge bg-secondary"><i class="bi bi-trophy-fill"></i> 2</span>
                                        {% elif forloop.counter == 3 %}
                                        <span class="badge" style="background-color: #cd7f32;"><i class="bi bi-trophy-fill"></i> 3</span>
                                        {% else %}
                                        <span class="text-muted fw-bold">#{{ forloop.counter }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-person-circle text-muted fs-4 me-2"></i>
                                            <div>
                                                <span class="fw-bold">{{ stats.user.get_full_name|default:stats.user.username }}</span>
                                                {% if user.is_authenticated and stats.user == user %}
                                                <span class="badge bg-primary ms-1">You</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="text-success fw-bold">{{ stats.total_quizzes_passed }}</span>
                                        <span class="text-muted small">/{{ stats.total_quizzes_taken }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="{% if stats.accuracy >= 80 %}text-success{% elif stats.accuracy >= 50 %}text-warning{% else %}text-danger{% endif %}">
                                            {{ stats.accuracy }}%
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="text-danger"><i class="bi bi-fire"></i> {{ stats.longest_streak }}</span>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge xp-badge fs-6">{{ stats.xp_points }} XP</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-trophy text-muted" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">No Rankings Yet</h4>
                    <p class="text-muted">Be the first to climb the leaderboard!</p>
                    <a href="{% url 'quiz_home' %}" class="btn btn-primary">Take a Quiz</a>
                </div>
                {% endif %}

                {% if not user.is_authenticated %}
                <div class="text-center mt-4">
                    <p class="text-muted">Want to see your rank?</p>
                    <a href="{% url 'login' %}" class="btn btn-outline-primary">Login</a>
                    <span class="text-muted mx-2">or</span>
                    <a href="{% url 'signup' %}" class="btn btn-primary">Sign Up</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}
