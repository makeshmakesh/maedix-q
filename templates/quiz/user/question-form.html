{% extends 'base.html' %}

{% block title %}{% if is_edit %}Edit Question{% else %}Add Question{% endif %} - {{ quiz.title }}{% endblock %}

{% block content %}
<section class="py-4 py-md-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb small">
                        <li class="breadcrumb-item"><a href="{% url 'user_quiz_list' %}">My Quizzes</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'user_quiz_questions' quiz.pk %}">{{ quiz.title }}</a></li>
                        <li class="breadcrumb-item active">{% if is_edit %}Edit{% else %}Add{% endif %} Question</li>
                    </ol>
                </nav>

                <div class="card p-4">
                    <h3 class="fw-bold mb-4">{% if is_edit %}Edit Question{% else %}Add Question{% endif %}</h3>

                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="order" value="0">

                        {% if form.errors %}
                        <div class="alert alert-danger">
                            <strong>Form errors:</strong>
                            {{ form.errors }}
                        </div>
                        {% endif %}

                        {% if formset.errors %}
                        <div class="alert alert-danger">
                            <strong>Option errors:</strong>
                            {{ formset.errors }}
                        </div>
                        {% endif %}

                        <div class="mb-4">
                            <label for="id_text" class="form-label">Question Text *</label>
                            <textarea name="text" id="id_text" class="form-control" rows="3" required
                                      placeholder="Enter your question here...">{{ form.text.value|default:'' }}</textarea>
                            {% if form.text.errors %}
                            <div class="text-danger small">{{ form.text.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="id_question_type" class="form-label">Question Type</label>
                                <select name="question_type" id="id_question_type" class="form-select">
                                    <option value="single" {% if form.question_type.value == 'single' %}selected{% endif %}>Single Choice</option>
                                    <option value="multiple" {% if form.question_type.value == 'multiple' %}selected{% endif %}>Multiple Choice</option>
                                    <option value="true_false" {% if form.question_type.value == 'true_false' %}selected{% endif %}>True/False</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="id_points" class="form-label">Points</label>
                                <input type="number" name="points" id="id_points" class="form-control"
                                       value="{{ form.points.value|default:'1' }}" min="1" max="10">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="id_code_snippet" class="form-label">Code Snippet (optional)</label>
                            <textarea name="code_snippet" id="id_code_snippet" class="form-control font-monospace" rows="4"
                                      placeholder="# Add code if the question involves code...">{{ form.code_snippet.value|default:'' }}</textarea>
                            <small class="text-muted">If your question involves code, add it here. It will be displayed with the question.</small>
                        </div>

                        <div class="mb-4">
                            <label for="id_explanation" class="form-label">Explanation (optional)</label>
                            <textarea name="explanation" id="id_explanation" class="form-control" rows="2"
                                      placeholder="Explain the correct answer...">{{ form.explanation.value|default:'' }}</textarea>
                            <small class="text-muted">This will be shown to users after they answer the question.</small>
                        </div>

                        <hr class="my-4">

                        <h5 class="fw-bold mb-3">Answer Options</h5>
                        <p class="text-muted small mb-3">Add at least 2 options and mark the correct one(s). Empty options will be ignored.</p>

                        {% if formset.non_form_errors %}
                        <div class="alert alert-danger">
                            {% for error in formset.non_form_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}

                        {{ formset.management_form }}
                        <div id="options-container">
                            {% for option_form in formset %}
                            <div class="option-row card p-3 mb-3 bg-light">
                                <div class="row align-items-center">
                                    <div class="col">
                                        {{ option_form.text }}
                                        {% if option_form.text.errors %}
                                        <div class="text-danger small">{{ option_form.text.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-auto">
                                        <div class="form-check">
                                            {{ option_form.is_correct }}
                                            <label class="form-check-label" for="{{ option_form.is_correct.id_for_label }}">
                                                Correct
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                {{ option_form.id }}
                                <input type="hidden" name="{{ option_form.order.html_name }}" value="{{ forloop.counter0 }}">
                            </div>
                            {% endfor %}
                        </div>

                        <hr class="my-4">

                        <div class="d-flex flex-wrap gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check"></i> {% if is_edit %}Save Changes{% else %}Add Question{% endif %}
                            </button>
                            <a href="{% url 'user_quiz_questions' quiz.pk %}" class="btn btn-outline-secondary">Cancel</a>
                        </div>
                    </form>
                </div>

                <div class="alert alert-info mt-4">
                    <h6 class="fw-bold"><i class="bi bi-lightbulb"></i> Tips</h6>
                    <ul class="mb-0 small">
                        <li>For single choice questions, mark only one option as correct.</li>
                        <li>For multiple choice questions, mark all correct options.</li>
                        <li>Make sure wrong options are plausible to make the quiz challenging.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
