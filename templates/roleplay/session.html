{% extends 'base.html' %}

{% block title %}{{ bot.name }} - Voice Roleplay{% endblock %}

{% block extra_css %}
<style>
    /* Mobile-first base styles */
    .session-container {
        max-width: 100%;
        margin: 0 auto;
        padding: 0 1rem;
    }

    .bot-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--primary);
    }

    .bot-avatar-placeholder {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--primary-light);
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px solid var(--primary);
    }

    .bot-avatar-placeholder i {
        font-size: 2rem;
    }

    .bot-info h2 {
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
    }

    .bot-info p {
        font-size: 0.875rem;
    }

    .voice-indicator {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: var(--bg-gray);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        transition: all 0.3s ease;
    }

    .voice-indicator i {
        font-size: 2.5rem;
    }

    .voice-indicator.speaking {
        background: var(--primary);
        animation: pulse 1s infinite;
    }

    .voice-indicator.speaking i {
        color: white;
    }

    .voice-indicator.listening {
        background: #22c55e;
        animation: pulse 0.8s infinite;
    }

    .voice-indicator.listening i {
        color: white;
    }

    .voice-indicator.processing {
        background: #f59e0b;
    }

    .voice-indicator.processing i {
        color: white;
    }

    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
        50% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(99, 102, 241, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
    }

    .mic-button {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        border: none;
        font-size: 1.5rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    .mic-button i {
        line-height: 1;
    }

    .mic-button.active {
        background: #22c55e !important;
    }

    .mic-button.muted {
        background: #ef4444 !important;
    }

    .transcript-box {
        height: 180px;
        overflow-y: auto;
        background: var(--bg-gray);
        border-radius: 12px;
        padding: 0.75rem;
    }

    .transcript-message {
        padding: 0.5rem 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 12px;
        max-width: 90%;
        font-size: 0.875rem;
    }

    .transcript-message.user {
        background: var(--primary);
        color: white;
        margin-left: auto;
    }

    .transcript-message.bot {
        background: var(--bg-white);
        border: 1px solid var(--border-color);
    }

    .credits-display {
        position: fixed;
        top: 70px;
        right: 10px;
        background: var(--bg-white);
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        font-size: 0.875rem;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.35rem;
    }

    .status-indicator.connected { background: #22c55e; }
    .status-indicator.disconnected { background: #ef4444; }
    .status-indicator.connecting { background: #f59e0b; animation: blink 1s infinite; }

    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .live-transcript {
        font-style: italic;
        color: var(--text-muted);
        padding: 0.5rem;
        font-size: 0.875rem;
    }

    .instruction-text {
        font-size: 0.8rem;
    }

    /* Tablet and up */
    @media (min-width: 576px) {
        .session-container {
            max-width: 500px;
            padding: 0;
        }

        .bot-avatar,
        .bot-avatar-placeholder {
            width: 100px;
            height: 100px;
        }

        .bot-avatar-placeholder i {
            font-size: 2.5rem;
        }

        .bot-info h2 {
            font-size: 1.5rem;
        }

        .voice-indicator {
            width: 120px;
            height: 120px;
        }

        .voice-indicator i {
            font-size: 3rem;
        }

        .mic-button {
            width: 70px;
            height: 70px;
            font-size: 1.75rem;
        }

        .transcript-box {
            height: 220px;
            padding: 1rem;
        }

        .transcript-message {
            font-size: 1rem;
            max-width: 85%;
        }

        .credits-display {
            top: 80px;
            right: 20px;
            padding: 0.5rem 1rem;
            font-size: 1rem;
        }
    }

    /* Desktop */
    @media (min-width: 768px) {
        .session-container {
            max-width: 550px;
        }

        .bot-avatar,
        .bot-avatar-placeholder {
            width: 120px;
            height: 120px;
            border-width: 4px;
        }

        .bot-avatar-placeholder i {
            font-size: 3rem;
        }

        .voice-indicator {
            width: 140px;
            height: 140px;
        }

        .mic-button {
            width: 80px;
            height: 80px;
            font-size: 2rem;
        }

        .transcript-box {
            height: 250px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-3 py-md-4">
    <div class="session-container">
        <!-- Credits Display -->
        <div class="credits-display">
            <i class="bi bi-coin text-warning me-1"></i>
            <span id="creditsDisplay">{{ credits }}</span> credits
        </div>

        <!-- Bot Info -->
        <div class="text-center mb-3 mb-md-4 bot-info">
            {% if bot.avatar_url %}
            <img src="{{ bot.avatar_url }}" alt="{{ bot.name }}" class="bot-avatar mb-2 mb-md-3">
            {% else %}
            <div class="bot-avatar-placeholder mb-2 mb-md-3 mx-auto">
                <i class="bi bi-robot text-primary"></i>
            </div>
            {% endif %}
            <h2>{{ bot.name }}</h2>
            <p class="text-muted mb-2 d-none d-sm-block">{{ bot.description|truncatewords:15 }}</p>
            <div class="d-flex justify-content-center align-items-center gap-2">
                <span class="status-indicator connecting" id="statusIndicator"></span>
                <span id="statusText" class="small">Connecting...</span>
            </div>
        </div>

        <!-- Voice Indicator -->
        <div class="voice-indicator mb-3 mb-md-4" id="voiceIndicator">
            <i class="bi bi-soundwave" id="voiceIcon"></i>
        </div>

        <!-- Controls -->
        <div class="text-center mb-3 mb-md-4">
            <button class="mic-button btn btn-primary mx-auto" id="micButton" disabled>
                <i class="bi bi-mic-fill" id="micIcon"></i>
            </button>
            <p class="mt-2 text-muted instruction-text" id="instructionText">Click to start conversation</p>
        </div>

        <!-- Transcript -->
        <div class="card mb-3 mb-md-4">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <span class="small fw-medium">Conversation</span>
                <span class="text-muted small">
                    <i class="bi bi-clock me-1"></i>
                    <span id="durationDisplay">0:00</span>
                </span>
            </div>
            <div class="card-body p-0">
                <div class="transcript-box" id="transcriptBox">
                    <p class="text-muted text-center mb-0 small" id="transcriptPlaceholder">
                        Start speaking to begin the conversation...
                    </p>
                </div>
            </div>
        </div>

        <!-- End Session -->
        <div class="text-center pb-3">
            <form method="post" action="{% url 'roleplay:end_session' session.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger btn-sm" id="endButton">
                    <i class="bi bi-stop-circle me-1"></i> End Session
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const sessionId = '{{ session.id }}';
    const wsUrl = '{{ ws_url }}';

    let ws = null;
    let audioContext = null;
    let mediaStream = null;
    let audioWorklet = null;
    let isListening = false;
    let sessionStartTime = Date.now();
    let durationInterval = null;

    // Audio playback
    let audioQueue = [];
    let isPlaying = false;

    // DOM Elements
    const micButton = document.getElementById('micButton');
    const micIcon = document.getElementById('micIcon');
    const voiceIndicator = document.getElementById('voiceIndicator');
    const voiceIcon = document.getElementById('voiceIcon');
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const transcriptBox = document.getElementById('transcriptBox');
    const transcriptPlaceholder = document.getElementById('transcriptPlaceholder');
    const creditsDisplay = document.getElementById('creditsDisplay');
    const durationDisplay = document.getElementById('durationDisplay');
    const instructionText = document.getElementById('instructionText');

    // Update duration display
    function updateDuration() {
        const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        durationDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    // Add message to transcript
    function addToTranscript(text, isUser) {
        if (transcriptPlaceholder) {
            transcriptPlaceholder.remove();
        }

        const msgDiv = document.createElement('div');
        msgDiv.className = `transcript-message ${isUser ? 'user' : 'bot'}`;
        msgDiv.textContent = text;
        transcriptBox.appendChild(msgDiv);
        transcriptBox.scrollTop = transcriptBox.scrollHeight;
    }

    // Update live transcript (streaming)
    let liveTranscriptEl = null;
    function updateLiveTranscript(text, isUser) {
        if (!liveTranscriptEl) {
            if (transcriptPlaceholder) transcriptPlaceholder.remove();
            liveTranscriptEl = document.createElement('div');
            liveTranscriptEl.className = `live-transcript ${isUser ? 'text-end' : ''}`;
            transcriptBox.appendChild(liveTranscriptEl);
        }
        liveTranscriptEl.textContent = text;
        transcriptBox.scrollTop = transcriptBox.scrollHeight;
    }

    function finalizeLiveTranscript(text, isUser) {
        if (liveTranscriptEl) {
            liveTranscriptEl.remove();
            liveTranscriptEl = null;
        }
        if (text) addToTranscript(text, isUser);
    }

    // Connect WebSocket
    function connectWebSocket() {
        ws = new WebSocket(wsUrl);

        ws.onopen = function() {
            console.log('WebSocket connected');
            statusIndicator.className = 'status-indicator connected';
            statusText.textContent = 'Connected';
            micButton.disabled = false;
            durationInterval = setInterval(updateDuration, 1000);
            instructionText.textContent = 'Click microphone to start';
        };

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            handleServerMessage(data);
        };

        ws.onclose = function() {
            console.log('WebSocket disconnected');
            statusIndicator.className = 'status-indicator disconnected';
            statusText.textContent = 'Disconnected';
            micButton.disabled = true;
            stopListening();
            if (durationInterval) clearInterval(durationInterval);
        };

        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
            statusIndicator.className = 'status-indicator disconnected';
            statusText.textContent = 'Error';
        };
    }

    // Handle messages from server
    function handleServerMessage(data) {
        switch (data.type) {
            case 'audio_delta':
                queueAudio(data.delta);
                break;

            case 'audio_done':
                voiceIndicator.classList.remove('speaking');
                voiceIcon.className = 'bi bi-soundwave';
                break;

            case 'assistant_transcript_delta':
                voiceIndicator.classList.add('speaking');
                voiceIcon.className = 'bi bi-volume-up text-white';
                updateLiveTranscript(data.delta, false);
                break;

            case 'assistant_transcript':
                finalizeLiveTranscript(data.text, false);
                break;

            case 'user_transcript':
                finalizeLiveTranscript(data.text, true);
                break;

            case 'speech_started':
                voiceIndicator.classList.add('listening');
                voiceIcon.className = 'bi bi-mic-fill text-white';
                instructionText.textContent = 'Listening...';
                break;

            case 'speech_stopped':
                voiceIndicator.classList.remove('listening');
                voiceIndicator.classList.add('processing');
                voiceIcon.className = 'bi bi-hourglass-split';
                instructionText.textContent = 'Processing...';
                break;

            case 'credits_update':
                creditsDisplay.textContent = data.credits;
                break;

            case 'text':
                console.log('Server:', data.text);
                break;

            case 'session_ready':
                console.log('OpenAI session ready');
                instructionText.textContent = 'Click microphone to start talking';
                break;

            case 'response_done':
                voiceIndicator.classList.remove('speaking', 'processing');
                voiceIcon.className = 'bi bi-soundwave';
                instructionText.textContent = 'Your turn to speak...';
                break;

            case 'error':
                alert(data.message);
                if (data.redirect) {
                    window.location.href = data.redirect;
                }
                break;
        }
    }

    // Audio playback using Web Audio API
    async function queueAudio(base64Audio) {
        try {
            const audioData = base64ToArrayBuffer(base64Audio);
            audioQueue.push(audioData);
            if (!isPlaying) {
                playNextAudio();
            }
        } catch (e) {
            console.error('Error queuing audio:', e);
        }
    }

    async function playNextAudio() {
        if (audioQueue.length === 0) {
            isPlaying = false;
            return;
        }

        isPlaying = true;
        const audioData = audioQueue.shift();

        try {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
            }

            // Convert PCM16 to Float32
            const pcm16 = new Int16Array(audioData);
            const float32 = new Float32Array(pcm16.length);
            for (let i = 0; i < pcm16.length; i++) {
                float32[i] = pcm16[i] / 32768;
            }

            const audioBuffer = audioContext.createBuffer(1, float32.length, 24000);
            audioBuffer.getChannelData(0).set(float32);

            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.onended = playNextAudio;
            source.start();

        } catch (e) {
            console.error('Error playing audio:', e);
            playNextAudio();
        }
    }

    function base64ToArrayBuffer(base64) {
        const binaryString = atob(base64);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    // Start listening (capture microphone)
    async function startListening() {
        try {
            mediaStream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    sampleRate: 24000,
                    channelCount: 1,
                    echoCancellation: true,
                    noiseSuppression: true
                }
            });

            audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
            const source = audioContext.createMediaStreamSource(mediaStream);

            // Use ScriptProcessor for audio capture (simpler than AudioWorklet)
            const processor = audioContext.createScriptProcessor(4096, 1, 1);

            processor.onaudioprocess = function(e) {
                if (!isListening || ws.readyState !== WebSocket.OPEN) return;

                const inputData = e.inputBuffer.getChannelData(0);
                const pcm16 = new Int16Array(inputData.length);

                for (let i = 0; i < inputData.length; i++) {
                    pcm16[i] = Math.max(-32768, Math.min(32767, inputData[i] * 32768));
                }

                const base64 = arrayBufferToBase64(pcm16.buffer);
                ws.send(JSON.stringify({ type: 'audio', audio: base64 }));
            };

            source.connect(processor);
            processor.connect(audioContext.destination);

            isListening = true;
            micButton.classList.add('active');
            micIcon.className = 'bi bi-mic-fill';
            instructionText.textContent = 'Speak naturally - AI will respond automatically';

            voiceIndicator.classList.remove('processing', 'speaking');

        } catch (error) {
            console.error('Error accessing microphone:', error);
            alert('Could not access microphone. Please grant permission.');
        }
    }

    function stopListening() {
        isListening = false;

        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
            mediaStream = null;
        }

        micButton.classList.remove('active');
        micIcon.className = 'bi bi-mic-fill';
        voiceIndicator.classList.remove('listening', 'processing', 'speaking');
        voiceIcon.className = 'bi bi-soundwave';
        instructionText.textContent = 'Click microphone to resume';
    }

    function arrayBufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
    }

    // Toggle microphone
    micButton.addEventListener('click', function() {
        if (isListening) {
            stopListening();
        } else {
            startListening();
        }
    });

    // Initialize
    connectWebSocket();

    // Warn before leaving
    window.addEventListener('beforeunload', function(e) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
</script>
{% endblock %}
