{% extends 'staff/base.html' %}

{% block title %}{{ action }} Topic{% endblock %}

{% block staff_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold mb-0">{{ action }} Topic</h4>
    <a href="{% url 'staff_topic_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back
    </a>
</div>

<div class="card p-4">
    <form method="post">
        {% csrf_token %}

        <div class="mb-3">
            <label for="{{ form.title.id_for_label }}" class="form-label">Title *</label>
            {{ form.title }}
            {% if form.title.errors %}
            <div class="text-danger small">{{ form.title.errors.0 }}</div>
            {% endif %}
        </div>

        <div class="mb-3">
            <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
            {{ form.description }}
            <small class="text-muted">Brief description shown on topic cards (max 500 characters)</small>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.category.id_for_label }}" class="form-label">Category *</label>
                {{ form.category }}
                {% if form.category.errors %}
                <div class="text-danger small">{{ form.category.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
                {{ form.status }}
            </div>
        </div>

        <!-- Thumbnail Upload -->
        <div class="mb-3">
            <label class="form-label">Thumbnail Image</label>
            <div class="row align-items-start">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="file" class="form-control" id="thumbnailFile" accept="image/*">
                        <button type="button" class="btn btn-outline-primary" id="uploadThumbnailBtn">
                            <i class="bi bi-cloud-upload"></i> Upload
                        </button>
                    </div>
                    <input type="hidden" name="thumbnail_url" id="thumbnailUrl" value="{{ form.thumbnail_url.value|default:'' }}">
                    <small class="text-muted">Upload an image (max 5MB). JPEG, PNG, GIF, WebP supported.</small>
                    <div id="thumbnailUploadStatus" class="small mt-1"></div>
                </div>
                <div class="col-md-4">
                    <div id="thumbnailPreview" class="border rounded p-2 text-center" style="min-height: 100px;">
                        {% if form.thumbnail_url.value %}
                        <img src="{{ form.thumbnail_url.value }}" class="img-fluid rounded" style="max-height: 100px;">
                        {% else %}
                        <span class="text-muted small">No thumbnail</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.linked_quiz.id_for_label }}" class="form-label">Linked Quiz</label>
                {{ form.linked_quiz }}
                <small class="text-muted">Optional full quiz for deeper learning</small>
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.mini_quiz.id_for_label }}" class="form-label">Mini-Quiz</label>
                {{ form.mini_quiz }}
                <small class="text-muted">Optional 2-3 question quiz after cards</small>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="{{ form.order.id_for_label }}" class="form-label">Order</label>
                {{ form.order }}
                <small class="text-muted">Display order within category</small>
            </div>
            <div class="col-md-6 mb-3">
                <label for="{{ form.estimated_time.id_for_label }}" class="form-label">Estimated Time (minutes)</label>
                {{ form.estimated_time }}
            </div>
        </div>

        <div class="mb-4">
            <div class="form-check">
                {{ form.is_featured }}
                <label class="form-check-label" for="{{ form.is_featured.id_for_label }}">
                    Featured (shown on topics homepage)
                </label>
            </div>
        </div>

        <div class="d-grid d-md-flex gap-2">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg"></i> {{ action }} Topic
            </button>
            {% if topic %}
            <a href="{% url 'staff_topic_cards' topic.id %}" class="btn btn-outline-info">
                <i class="bi bi-layers"></i> Manage Cards
            </a>
            {% endif %}
            <a href="{% url 'staff_topic_list' %}" class="btn btn-outline-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
document.getElementById('uploadThumbnailBtn').addEventListener('click', async function() {
    const fileInput = document.getElementById('thumbnailFile');
    const urlInput = document.getElementById('thumbnailUrl');
    const preview = document.getElementById('thumbnailPreview');
    const status = document.getElementById('thumbnailUploadStatus');
    const btn = this;

    if (!fileInput.files.length) {
        status.innerHTML = '<span class="text-danger">Please select a file first</span>';
        return;
    }

    const file = fileInput.files[0];

    // Validate file size
    if (file.size > 5 * 1024 * 1024) {
        status.innerHTML = '<span class="text-danger">File too large. Max 5MB.</span>';
        return;
    }

    // Show uploading state
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Uploading...';
    status.innerHTML = '<span class="text-muted">Uploading...</span>';

    try {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('folder', 'topic-thumbnails');

        const response = await fetch('{% url "staff_image_upload" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });

        const data = await response.json();

        if (data.success) {
            urlInput.value = data.url;
            preview.innerHTML = `<img src="${data.url}" class="img-fluid rounded" style="max-height: 100px;">`;
            status.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> Uploaded successfully</span>';
        } else {
            status.innerHTML = `<span class="text-danger">${data.error}</span>`;
        }
    } catch (error) {
        status.innerHTML = `<span class="text-danger">Upload failed: ${error.message}</span>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-cloud-upload"></i> Upload';
    }
});

// Preview on file select
document.getElementById('thumbnailFile').addEventListener('change', function() {
    const preview = document.getElementById('thumbnailPreview');
    if (this.files.length) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded" style="max-height: 100px; opacity: 0.5;">
                <div class="small text-muted mt-1">Click Upload to save</div>`;
        };
        reader.readAsDataURL(this.files[0]);
    }
});
</script>
{% endblock %}
